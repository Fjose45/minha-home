<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setor Produtivo Florestal - Aplicativos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.0/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        // Configuração do Tailwind CSS para incluir cores e animações personalizadas, e habilitar o modo escuro
        tailwind.config = {
            darkMode: 'class', // Habilita o modo escuro baseado na classe 'dark' no elemento <html>
            theme: {
                extend: {
                    colors: {
                        // Paleta de cores futurista
                        primary: {
                            50: '#e0f7fa', 100: '#b2ebf2', 200: '#80deea', 300: '#4dd0e1', 400: '#26c6da',
                            500: '#00bcd4', 600: '#00acc1', 700: '#0097a7', 800: '#00838f', 900: '#006064', 950: '#003e42'
                        },
                        secondary: {
                            50: '#f3e5f5', 100: '#e1bee7', 200: '#ce93d8', 300: '#ba68c8', 400: '#ab47bc',
                            500: '#9c27b0', 600: '#8e24aa', 700: '#7b1fa2', 800: '#6a1b9a', 900: '#4a148c',
                        },
                        accent: { // Cores de destaque para neons/gradientes
                            'blue-neon': '#00F0FF',
                            'purple-neon': '#BF00FF',
                            'green-neon': '#00FF80',
                            'gradient-start': '#00F0FF',
                            'gradient-end': '#BF00FF',
                        },
                        success: {
                            50: '#f0fdf4', 100: '#dcfce7', 200: '#bbf7d0', 300: '#86efac', 400: '#4ade80',
                            500: '#22c55e', 600: '#16a34a', 700: '#15803d', 800: '#166534', 900: '#14532d',
                        },
                        danger: {
                            50: '#fef2f2', 100: '#fee2e2', 200: '#fecaca', 300: '#fca5a5', 400: '#f87171',
                            500: '#ef4444', 600: '#dc2626', 700: '#b91c1c', 800: '#991b1b', 900: '#7f1d1d',
                        },
                        warning: {
                            50: '#fffbeb', 100: '#fef3c7', 200: '#fde68a', 300: '#fcd34d', 400: '#fbbf24',
                            500: '#f59e0b', 600: '#d97706', 700: '#b45309', 800: '#92400e', 900: '#78350f',
                        },
                        info: {
                            50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd', 400: '#60a5fa',
                            500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 800: '#1e40af', 900: '#1e3a8a',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'pulse-slow': 'pulse 3s infinite',
                        'bounce-slow': 'bounceSlow 2s infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'glow': 'glow 1.5s ease-in-out infinite alternate', // Animação de brilho neon
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        bounceSlow: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-8px)' } },
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        glow: { // Keyframes para o efeito de brilho neon
                            '0%': { textShadow: '0 0 5px var(--accent-blue-neon), 0 0 10px var(--accent-blue-neon)' },
                            '100%': { textShadow: '0 0 10px var(--accent-blue-neon), 0 0 20px var(--accent-blue-neon), 0 0 30px var(--accent-blue-neon)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Importa a fonte Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        /* Variáveis CSS para cores do tema */
        :root {
            /* Cores base para o tema claro */
            --bg-color-light: linear-gradient(135deg, #e0f7fa, #f3e5f5); /* Gradiente suave */
            --text-color-light: #2c3e50; /* Azul escuro para contraste */
            --header-bg-light: rgba(255, 255, 255, 0.8); /* Fundo semi-transparente */
            --shadow-light: 0 8px 16px rgba(0, 0, 0, 0.1);
            --card-bg-light: rgba(255, 255, 255, 0.85); /* Fundo do card para glassmorphism - AUMENTADO OPACIDADE */
            --card-border-light: rgba(0, 0, 0, 0.1); /* Borda do card para glassmorphism - MENOS TRANSPARENTE */
            --input-bg-light: rgba(255, 255, 255, 0.9); /* AUMENTADO OPACIDADE */
            --input-border-light: rgba(0, 0, 0, 0.2); /* MENOS TRANSPARENTE */
            --input-text-light: #2c3e50;
            --table-header-bg-light: rgba(240, 240, 240, 0.8); /* MAIS SÓLIDO */
            --table-row-odd-light: rgba(255, 255, 255, 0.7); /* MAIS SÓLIDO */
            --table-row-even-light: rgba(245, 245, 245, 0.7); /* MAIS SÓLIDO */
            --modal-bg-light: rgba(255, 255, 255, 0.9); /* AUMENTADO OPACIDADE */
            --modal-header-bg-light: rgba(240, 240, 240, 0.9); /* AUMENTADO OPACIDADE */
            --modal-text-light: #2c3e50;
            --modal-input-bg-light: rgba(255, 255, 255, 0.9); /* AUMENTADO OPACIDADE */
            --modal-input-border-light: rgba(0, 0, 0, 0.2); /* MENOS TRANSPARENTE */
            --modal-input-text-light: #2c3e50;
            --footer-bg-light: rgba(255, 255, 255, 0.8);
            --footer-text-light: #34495e;
            --overlay-bg-light: rgba(0,0,0,0.4); /* Overlay mais suave */

            /* Cores específicas da calculadora (mantendo o contraste) */
            --calculator-bg-light: rgba(30, 41, 59, 0.9); /* Fundo da calculadora mais escuro para contraste - AUMENTADO OPACIDADE */
            --calculator-card-bg-light: rgba(45, 62, 80, 0.9); /* AUMENTADO OPACIDADE */
            --calculator-text-light: #ecf0f1;
            --calculator-input-bg-light: rgba(60, 78, 96, 0.9); /* AUMENTADO OPACIDADE */
            --calculator-input-border-light: rgba(90, 108, 126, 0.9); /* AUMENTADO OPACIDADE */
            --calculator-table-header-bg-light: rgba(60, 78, 96, 0.9); /* AUMENTADO OPACIDADE */
            --calculator-table-row-bg-light: rgba(45, 62, 80, 0.9); /* AUMENTADO OPACIDADE */
            --calculator-table-row-hover-light: rgba(60, 78, 96, 0.9); /* AUMENTADO OPACIDADE */
            --calculator-subtotal-text-light: #3498db;
            --calculator-total-text-light: #2ecc71;
            --calculator-required-text-light: #e74c3c;
            --calculator-scroll-thumb-light: #3498db;
            --calculator-scroll-track-light: #7f8c8d;
            --resumo-especie-bg-light: rgba(243, 244, 246, 0.9); /* Fundo claro para resumo de espécies - AUMENTADO OPACIDADE */
            --resumo-especie-text-light: #333;


            /* Cores para o tema escuro */
            --bg-color-dark: linear-gradient(135deg, #0f172a, #1a202c); /* Gradiente escuro */
            --text-color-dark: #ecf0f1; /* Branco suave */
            --header-bg-dark: rgba(30, 41, 59, 0.8);
            --shadow-dark: 0 8px 16px rgba(0, 0, 0, 0.4);
            --card-bg-dark: rgba(30, 41, 59, 0.2);
            --card-border-dark: rgba(45, 62, 80, 0.4);
            --input-bg-dark: rgba(30, 41, 59, 0.2);
            --input-border-dark: rgba(45, 62, 80, 0.4);
            --input-text-dark: #ecf0f1;
            --table-header-bg-dark: rgba(45, 62, 80, 0.3);
            --table-row-odd-dark: rgba(30, 41, 59, 0.1);
            --table-row-even-dark: rgba(45, 62, 80, 0.15);
            --modal-bg-dark: rgba(30, 41, 59, 0.3);
            --modal-header-bg-dark: rgba(45, 62, 80, 0.4);
            --modal-text-dark: #ecf0f1;
            --modal-input-bg-dark: rgba(30, 41, 59, 0.2);
            --modal-input-border-dark: rgba(45, 62, 80, 0.4);
            --modal-input-text-dark: #ecf0f1;
            --footer-bg-dark: rgba(30, 41, 59, 0.8);
            --footer-text-dark: #bdc3c7;
            --overlay-bg-dark: rgba(0,0,0,0.7);

            /* Cores específicas da calculadora para o tema escuro */
            --calculator-bg-dark: #1a202c;
            --calculator-card-bg-dark: #2d3748;
            --calculator-text-dark: #e5e7eb;
            --calculator-input-bg-dark: #374151;
            --calculator-input-border-dark: #4a5568;
            --calculator-table-header-bg-dark: #4a5568;
            --calculator-table-row-bg-dark: #2d3748;
            --calculator-table-row-hover-dark: #374151;
            --calculator-subtotal-text-dark: #60a5fa;
            --calculator-total-text-dark: #4ade80;
            --calculator-required-text-dark: #f87171;
            --calculator-scroll-thumb-dark: #60a5fa;
            --calculator-scroll-track-dark: #374151;
            --resumo-especie-bg-dark: rgba(243, 244, 246, 0.8);
            --resumo-especie-text-dark: #333;
        }

        /* Estilos globais para o corpo e transições de tema */
        body {
            font-family: 'Inter', sans-serif;
            color: var(--text-color-light);
            background: var(--bg-color-light);
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
            min-height: 100vh;
            transition: background 0.5s ease, color 0.5s ease; /* Transição mais suave */
        }

        /* Estilos para o modo escuro */
        .dark body {
            background: var(--bg-color-dark);
            color: var(--text-color-dark);
        }

        /* Estilos para modais */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background-color: var(--overlay-bg-light);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            transition: opacity 0.3s ease, background-color 0.3s ease;
            opacity: 0;
            pointer-events: none;
        }
        .modal.active {
            display: flex;
            opacity: 1;
            pointer-events: auto;
        }
        .dark .modal {
            background-color: var(--overlay-bg-dark);
        }

        .modal-content {
            background-color: var(--modal-bg-light);
            padding: 0;
            border-radius: 1rem; /* Mais arredondado */
            width: 95vw; /* Ajuste para melhor visualização em telas maiores */
            height: 95vh;
            max-width: 100vw;
            max-height: 100vh;
            overflow: auto;
            box-shadow: var(--shadow-light);
            display: flex;
            flex-direction: column;
            transition: background-color 0.5s ease, color 0.5s ease, box-shadow 0.5s ease;
            backdrop-filter: blur(10px); /* Efeito de vidro */
            border: 1px solid var(--card-border-light); /* Borda sutil */
        }
        .dark .modal-content {
            background-color: var(--modal-bg-dark);
            color: var(--modal-text-dark);
            box-shadow: var(--shadow-dark);
            border: 1px solid var(--card-border-dark);
        }

        /* Estilos para cabeçalhos e footers de modais */
        .modal-header {
            background-color: var(--modal-header-bg-light);
            color: var(--modal-text-light);
            transition: background-color 0.5s ease, color 0.5s ease;
            border-bottom: 1px solid var(--card-border-light); /* Borda para separar */
        }
        .dark .modal-header {
            background-color: var(--modal-header-bg-dark);
            color: var(--modal-text-dark);
            border-bottom: 1px solid var(--card-border-dark);
        }

        /* Estilos de input genéricos para modais */
        .modal-input {
            background-color: var(--modal-input-bg-light);
            border: 1px solid var(--modal-input-border-light);
            color: var(--modal-input-text-light);
            transition: background-color 0.5s ease, border-color 0.5s ease, color 0.5s ease;
            border-radius: 0.5rem; /* Mais arredondado */
        }
        .dark .modal-input {
            background-color: var(--modal-input-bg-dark);
            border-color: var(--modal-input-border-dark);
            color: var(--modal-input-text-dark);
        }
        .modal-input:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(var(--primary-500-rgb), 0.5); /* Efeito de foco mais futurista */
        }
        /* Definir RGB para cores primárias para o box-shadow */
        :root {
            --primary-500-rgb: 0, 188, 212; /* Exemplo para primary-500 */
        }
        .dark {
            --primary-500-rgb: 0, 188, 212; /* Manter o mesmo para consistência no foco */
        }


        /* Estilos específicos para a Calculadora de Volume */
        #calculator-modal .modal-content {
            background-color: var(--calculator-bg-light);
        }
        .dark #calculator-modal .modal-content {
            background-color: var(--calculator-bg-dark);
        }
        #calculator-modal .bg-gray-700 { background-color: var(--calculator-input-bg-light); }
        .dark #calculator-modal .bg-gray-700 { background-color: var(--calculator-input-bg-dark); }
        #calculator-modal .border-gray-600 { border-color: var(--calculator-input-border-light); }
        .dark #calculator-modal .border-gray-600 { border-color: var(--calculator-input-border-dark); }
        #calculator-modal .text-white { color: var(--calculator-text-light); }
        .dark #calculator-modal .text-white { color: var(--calculator-text-dark); }
        #calculator-modal .bg-gray-800 { background-color: var(--calculator-card-bg-light); }
        .dark #calculator-modal .bg-gray-800 { background-color: var(--calculator-card-bg-dark); }
        #calculator-modal .bg-gray-50 { background-color: var(--calculator-table-header-bg-light); }
        .dark #calculator-modal .bg-gray-50 { background-color: var(--calculator-table-header-bg-dark); }
        #calculator-modal .text-gray-300 { color: var(--calculator-text-light); }
        .dark #calculator-modal .text-gray-300 { color: var(--calculator-text-dark); }
        #calculator-modal .text-gray-400 { color: var(--calculator-text-light); }
        .dark #calculator-modal .text-gray-400 { color: var(--calculator-text-dark); }
        #calculator-modal .text-green-400 { color: var(--calculator-total-text-light); }
        .dark #calculator-modal .text-green-400 { color: var(--calculator-total-text-dark); }
        #calculator-modal .text-blue-400 { color: var(--calculator-subtotal-text-light); }
        .dark #calculator-modal .text-blue-400 { color: var(--calculator-subtotal-text-dark); }
        #calculator-modal .negative-volume { background-color: rgba(231,76,60,0.2) !important; } /* Cor mais suave */
        #calculator-modal .positive-volume { background-color: rgba(46,204,113,0.2) !important; } /* Cor mais suave */
        #calculator-modal .resumo-especie {
            background-color: var(--resumo-especie-bg-light) !important;
            color: var(--resumo-especie-text-light) !important;
            border: 1px solid rgba(0,0,0,0.1);
        }
        .dark #calculator-modal .resumo-especie {
            background-color: var(--resumo-especie-bg-dark) !important;
            color: var(--resumo-especie-text-dark) !important;
            border-color: rgba(255,255,255,0.1);
        }
        /* Ajuste para garantir que o texto dentro do resumo de espécies seja escuro em ambos os temas */
        #calculator-modal .resumo-especie .text-gray-700,
        #calculator-modal .resumo-especie .font-medium {
            color: var(--resumo-especie-text-light) !important;
        }
        .dark #calculator-modal .resumo-especie .text-gray-700,
        .dark #calculator-modal .resumo-especie .font-medium {
            color: var(--resumo-especie-text-dark) !important;
        }


        /* Estilos do Romaneio de Madeira Serrada */
        #romaneio-modal .modal-content {
            background-color: var(--card-bg-light);
        }
        .dark #romaneio-modal .modal-content {
            background-color: var(--card-bg-dark);
        }
        #romaneio-modal .card {
            box-shadow: var(--shadow-light);
            background: var(--card-bg-light);
            border-radius: 1rem;
            overflow: hidden;
            backdrop-filter: blur(8px); /* Glassmorphism */
            border: 1px solid var(--card-border-light);
        }
        .dark #romaneio-modal .card {
            box-shadow: var(--shadow-dark);
            background-color: var(--card-bg-dark);
            border-color: var(--card-border-dark);
        }
        #romaneio-modal .input {
            background-color: var(--input-bg-light);
            color: var(--input-text-light);
            border: 1px solid var(--input-border-light);
            border-radius: 0.5rem;
        }
        .dark #romaneio-modal .input {
            background-color: var(--input-bg-dark);
            color: var(--input-text-dark);
            border-color: var(--input-border-dark);
        }
        #romaneio-modal .table-container {
            background-color: var(--card-bg-light);
            color: var(--text-color-light);
            border-radius: 1rem;
            overflow-x: auto; /* REMOVIDO scrollbar-hide */
            backdrop-filter: blur(8px);
            border: 1px solid var(--card-border-light);
        }
        .dark #romaneio-modal .table-container {
            background-color: var(--card-bg-dark);
            color: var(--text-color-dark);
            border-color: var(--card-border-dark);
        }
        #romaneio-modal table { color: var(--text-color-light); }
        .dark #romaneio-modal table { color: var(--text-color-dark); }
        #romaneio-modal thead { background-color: var(--table-header-bg-light); }
        .dark #romaneio-modal thead { background-color: var(--table-header-bg-dark); }
        #romaneio-modal tbody tr:nth-child(odd) { background-color: var(--table-row-odd-light); }
        .dark #romaneio-modal tbody tr:nth-child(odd) { background-color: var(--table-row-odd-dark); }
        #romaneio-modal tbody tr:nth-child(even) { background-color: var(--table-row-even-light); }
        .dark #romaneio-modal tbody tr:nth-child(even) { background-color: var(--table-row-even-dark); }
        #romaneio-modal .text-gray-800 { color: var(--text-color-light); }
        .dark #romaneio-modal .text-gray-800 { color: var(--text-color-dark); }
        #romaneio-modal .text-gray-500 { color: #8e8e8e; } /* Mais claro */
        .dark #romaneio-modal .text-gray-500 { color: #a0a0a0; } /* Mais claro */
        #romaneio-modal .text-gray-400 { color: #9e9e9e; } /* Mais claro */
        .dark #romaneio-modal .text-gray-400 { color: #707070; } /* Mais escuro */
        #romaneio-modal .border-gray-200 { border-color: var(--card-border-light); }
        .dark #romaneio-modal .border-gray-200 { border-color: var(--card-border-dark); }
        #romaneio-modal .bg-gray-50 { background-color: var(--table-header-bg-light); }
        .dark #romaneio-modal .bg-gray-50 { background-color: var(--table-header-bg-dark); }

        /* Estilos do Resumo de Pedidos */
        #resumo-pedidos-modal .modal-content {
            background-color: var(--card-bg-light);
        }
        .dark #resumo-pedidos-modal .modal-content {
            background-color: var(--card-bg-dark);
        }
        #resumo-pedidos-modal .overlay {
            background-color: var(--overlay-bg-light);
            min-height: 100vh;
            backdrop-filter: blur(5px);
        }
        .dark #resumo-pedidos-modal .overlay {
            background-color: var(--overlay-bg-dark);
        }
        #resumo-pedidos-modal .bg-white { /* Usado para o card principal */
            background-color: var(--card-bg-light);
            backdrop-filter: blur(8px);
            border: 1px solid var(--card-border-light);
        }
        .dark #resumo-pedidos-modal .bg-white {
            background-color: var(--card-bg-dark);
            border-color: var(--card-border-dark);
        }
        #resumo-pedidos-modal .text-gray-800 { color: var(--text-color-light); }
        .dark #resumo-pedidos-modal .text-gray-800 { color: var(--text-color-dark); }
        #resumo-pedidos-modal .text-gray-700 { color: var(--text-color-light); }
        .dark #resumo-pedidos-modal .text-gray-700 { color: var(--text-color-dark); }
        #resumo-pedidos-modal .border { border-color: var(--card-border-light); }
        .dark #resumo-pedidos-modal .border { border-color: var(--card-border-dark); }
        #resumo-pedidos-modal input,
        #resumo-pedidos-modal select,
        #resumo-pedidos-modal textarea {
            background-color: var(--input-bg-light);
            color: var(--input-text-light);
            border-color: var(--input-border-light);
            border-radius: 0.5rem;
        }
        .dark #resumo-pedidos-modal input,
        .dark #resumo-pedidos-modal select,
        .dark #resumo-pedidos-modal textarea {
            background-color: var(--input-bg-dark);
            color: var(--input-text-dark);
            border-color: var(--input-border-dark);
        }
        #resumo-pedidos-modal input::placeholder,
        #resumo-pedidos-modal textarea::placeholder {
            color: #b0b0b0; /* Mais visível */
        }
        .dark #resumo-pedidos-modal input::placeholder,
        .dark #resumo-pedidos-modal textarea::placeholder {
            color: #707070;
        }
        #resumo-pedidos-modal .bg-gray-50 { background-color: var(--table-header-bg-light); }
        .dark #resumo-pedidos-modal .bg-gray-50 { background-color: var(--table-header-bg-dark); }
        #resumo-pedidos-modal .text-gray-500 { color: #8e8e8e; }
        .dark #resumo-pedidos-modal .text-gray-500 { color: #a0a0a0; }
        #resumo-pedidos-modal .divide-gray-200 > :not([hidden]) ~ :not([hidden]) {
            border-color: var(--card-border-light);
        }
        .dark #resumo-pedidos-modal .divide-gray-200 > :not([hidden]) ~ :not([hidden]) {
            border-color: var(--card-border-dark);
        }
        #resumo-pedidos-modal #pedidos-list tr {
            background-color: var(--card-bg-light);
        }
        .dark #resumo-pedidos-modal #pedidos-list tr {
            background-color: var(--card-bg-dark);
        }
        #resumo-pedidos-modal #pedidos-list tr:hover {
            background-color: rgba(255,255,255,0.15);
        }
        .dark #resumo-pedidos-modal #pedidos-list tr:hover {
            background-color: rgba(45,62,80,0.2);
        }
        #resumo-pedidos-modal .text-red-500 { color: #e74c3c; }
        .dark #resumo-pedidos-modal .text-red-500 { color: #f87171; }
        #resumo-pedidos-modal .text-blue-600 { color: #3498db; }
        .dark #resumo-pedidos-modal .text-blue-600 { color: #60a5fa; }
        #resumo-pedidos-modal .text-green-600 { color: #2ecc71; }
        .dark #resumo-pedidos-modal .text-green-600 { color: #4ade80; }

        /* Estilos específicos para o Gerador de Orçamento */
        #invoice-modal .modal-content {
            background-color: var(--card-bg-light);
        }
        .dark #invoice-modal .modal-content {
            background-color: var(--card-bg-dark);
        }
        #invoice-modal .bg-gray-100 { /* Fundo da área de conteúdo do modal */
            background-color: transparent; /* Torna transparente para ver o fundo do modal */
        }
        .dark #invoice-modal .bg-gray-100 {
            background-color: transparent;
        }
        #invoice-modal .bg-white { /* Usado para a tabela de itens */
            background-color: var(--card-bg-light);
            backdrop-filter: blur(8px);
            border: 1px solid var(--card-border-light);
        }
        .dark #invoice-modal .bg-white {
            background-color: var(--card-bg-dark);
            border-color: var(--card-border-dark);
        }
        #invoice-modal .text-gray-700 {
            color: var(--text-color-light);
        }
        .dark #invoice-modal .text-gray-700 {
            color: var(--text-color-dark);
        }
        #invoice-modal .border-gray-300 {
            border-color: var(--input-border-light);
        }
        .dark #invoice-modal .border-gray-300 {
            border-color: var(--input-border-dark);
        }
        #invoice-modal .bg-gray-50 {
            background-color: var(--table-header-bg-light);
        }
        .dark #invoice-modal .bg-gray-50 {
            background-color: var(--table-header-bg-dark);
        }
        #invoice-modal .text-gray-500 {
            color: #8e8e8e;
        }
        .dark #invoice-modal .text-gray-500 {
            color: #a0a0a0;
        }
        #invoice-modal .divide-gray-200 > :not([hidden]) ~ :not([hidden]) {
            border-color: var(--card-border-light);
        }
        .dark #invoice-modal .divide-gray-200 > :not([hidden]) ~ :not([hidden]) {
            border-color: var(--card-border-dark);
        }
        #invoice-modal .invoice-total {
            color: var(--text-color-light);
        }
        .dark #invoice-modal .invoice-total {
            color: var(--text-color-dark);
        }


        /* Estilos comuns para todos os aplicativos */
        .calculator-table input,
        .calculator-table select,
        .calculator-table textarea,
        .input-mobile {
            width: 100%;
            min-width: 0;
            font-size: 1rem;
            padding: 0.5rem;
            box-sizing: border-box;
        }
        .calculator-table th, .calculator-table td {
            padding: 0.5rem;
        }
        .currency-input {
            position: relative;
        }
        .currency-input::before {
            content: 'R$';
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--input-text-light); /* Cor do texto do input */
            font-weight: 500;
        }
        .dark .currency-input::before {
            color: var(--input-text-dark);
        }
        .currency-input input {
            padding-left: 30px !important;
        }

        .forest-hero {
            /* NOVO GRADIENTE MAIS TECNOLÓGICO E FLORESTAL */
            background: linear-gradient(135deg, rgba(0, 100, 0, 0.7), rgba(0, 200, 255, 0.7)), url('https://scontent.ftur3-1.fna.fbcdn.net/v/t39.30808-6/494351527_579886148463235_7321815471952606074_n.jpg?_nc_cat=111&ccb=1-7&_nc_sid=127cfc&_nc_eui2=AeH9h8m1n0oCv477CGMVzSPypTBJsxeQkFelMEmzF5CQV2DkZpcPwLvJKOeBTa-YAG34BOZ6y_O9ehzBOchOTK7z&_nc_ohc=Rb8x5Bhy7sYQ7kNvwGlqBL0&_nc_oc=AdlHRvTtICl0rVAd1kHh9Cx-naJDGp1u-ZZIM_l6KhI0EI5IDrkGgyRvTj8JEhHaYL_OT6mFe59VFo_xsfXlCgdY&_nc_zt=23&_nc_ht=scontent.ftur3-1.fna&_nc_gid=ULsv3w3L5GRWyFxdke1GPg&oh=00_AfLtSzQmR9ssdu5pSyfqQyxWZ1yzfOr2pMs30fY3n7VGog&oe=682D9002');
            background-size: cover;
            background-position: center;
            border-radius: 1rem;
            box-shadow: var(--shadow-light);
        }
        .dark .forest-hero {
            background: linear-gradient(135deg, rgba(0, 100, 0, 0.4), rgba(0, 200, 255, 0.4)), url('https://scontent.ftur3-1.fna.fbcdn.net/v/t39.30808-6/494351527_579886148463235_7321815471952606074_n.jpg?_nc_cat=111&ccb=1-7&_nc_sid=127cfc&_nc_eui2=AeH9h8m1n0oCv477CGMVzSPypTBJsxeQkFelMEmzF5CQV2DkZpcPwLvJKOeBTa-YAG34BOZ6y_O9ehzBOchOTK7z&_nc_ohc=Rb8x5Bhy7sYQ7kNvwGlqBL0&_nc_oc=AdlHRvTtICl0rVAd1kHh9Cx-naJDGp1u-ZZIM_l6KhI0EI5IDrkGgyRvTj8JEhHaYL_OT6mFe59VFo_xsfXlCgdY&_nc_zt=23&_nc_ht=scontent.ftur3-1.fna&_nc_gid=ULsv3w3L5GRWyFxdke1GPg&oh=00_AfLtSzQmR9ssdu5pSyfqQyxWZ1yzfOr2pMs30fY3n7VGog&oe=682D9002');
            box-shadow: var(--shadow-dark);
        }
        .service-card {
            transition: all 0.3s ease;
            border-bottom: 4px solid var(--primary-500);
        }
        .service-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .timeline-item {
            position: relative;
            padding-left: 2rem;
            margin-bottom: 2rem;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 2px;
            height: 100%;
            background: var(--primary-500);
        }
        .timeline-dot {
            position: absolute;
            left: -0.5rem;
            top: 0;
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            background: var(--primary-500);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .nav-link.active {
            color: var(--primary-700);
            font-weight: 600;
            border-bottom: 2px solid var(--primary-500);
        }
        .dark .nav-link.active {
            color: var(--primary-300);
            border-bottom-color: var(--primary-300);
        }

        /* Esconder scrollbars para table container */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* Estilos para cards de aplicativos */
        .app-icon {
            transition: all 0.3s ease;
            border-radius: 1rem;
            backdrop-filter: blur(8px); /* Glassmorphism */
            background-color: var(--card-bg-light);
            border: 1px solid var(--card-border-light);
            box-shadow: var(--shadow-light);
        }
        .app-icon:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.2);
            border-color: var(--accent-blue-neon); /* Efeito neon no hover */
        }
        .dark .app-icon {
            background-color: var(--card-bg-dark);
            color: var(--text-color-dark);
            border-color: var(--card-border-dark);
            box-shadow: var(--shadow-dark);
        }
        .dark .app-icon:hover {
            box-shadow: 0 12px 24px rgba(0,0,0,0.4);
            border-color: var(--accent-purple-neon);
        }
        .app-icon .bg-green-100 { background-color: rgba(0,255,128,0.2); } /* Verde neon suave */
        .app-icon .bg-blue-100 { background-color: rgba(0,240,255,0.2); } /* Azul neon suave */
        .app-icon .bg-purple-100 { background-color: rgba(191,0,255,0.2); } /* Roxo neon suave */
        .app-icon .bg-yellow-100 { background-color: rgba(255,255,0,0.2); } /* Amarelo neon suave */

        .app-icon .text-green-600 { color: var(--accent-green-neon); text-shadow: 0 0 5px rgba(0,255,128,0.5); }
        .app-icon .text-blue-600 { color: var(--accent-blue-neon); text-shadow: 0 0 5px rgba(0,240,255,0.5); }
        .app-icon .text-purple-600 { color: var(--accent-purple-neon); text-shadow: 0 0 5px rgba(191,0,255,0.5); }
        .app-icon .text-yellow-600 { color: #FFFF00; text-shadow: 0 0 5px rgba(255,255,0,0.5); }

        .app-icon h3 { color: var(--text-color-light); }
        .dark .app-icon h3 { color: var(--text-color-dark); }
        .app-icon p { color: #606060; }
        .dark .app-icon p { color: #b0b0b0; }

        /* Estilos para o botão de alternar tema */
        .theme-toggle {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            width: 3.5rem; /* Um pouco maior */
            height: 3.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 40;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            background: linear-gradient(135deg, var(--primary-500), var(--secondary-500)); /* Gradiente */
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            backdrop-filter: blur(5px);
        }
        .theme-toggle:hover {
            transform: translateY(-3px) scale(1.08); /* Efeito mais pronunciado */
            box-shadow: 0 8px 15px rgba(0,0,0,0.3);
            background: linear-gradient(135deg, var(--accent-blue-neon), var(--accent-purple-neon)); /* Gradiente neon no hover */
        }
        .theme-toggle i {
            animation: glow 1.5s ease-in-out infinite alternate; /* Aplica o brilho neon */
            --accent-blue-neon: #00F0FF; /* Define a variável localmente para a animação */
        }
        .dark .theme-toggle {
            background: linear-gradient(135deg, var(--primary-700), var(--secondary-700));
            border-color: rgba(0,0,0,0.3);
        }
        .dark .theme-toggle:hover {
            background: linear-gradient(135deg, var(--accent-purple-neon), var(--accent-green-neon));
        }
        .dark .theme-toggle i {
            --accent-blue-neon: #BF00FF; /* Muda a cor do brilho no dark mode */
        }


        /* Estilos para o toast/feedback */
        .toast {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            z-index: 100;
            padding: 0.75rem 1.25rem;
            border-radius: 0.75rem; /* Mais arredondado */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: fadeIn 0.3s ease-in-out;
            transition: all 0.3s ease;
            max-width: 24rem;
            backdrop-filter: blur(5px); /* Glassmorphism */
            border: 1px solid rgba(255,255,255,0.2);
        }
        .toast-success { background-color: rgba(46,204,113,0.8); color: white; }
        .toast-danger { background-color: rgba(231,76,60,0.8); color: white; }
        .toast-warning { background-color: rgba(241,196,15,0.8); color: white; }
        .toast-info { background-color: rgba(52,152,219,0.8); color: white; }

        /* Estilos para o modal de confirmação genérico */
        .confirm-modal {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background-color: var(--overlay-bg-light);
            z-index: 1100; /* Acima dos outros modais */
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .confirm-modal.active {
            display: flex;
            opacity: 1;
            pointer-events: auto;
        }
        .confirm-modal-content {
            background-color: var(--modal-bg-light);
            padding: 2rem; /* Mais padding */
            border-radius: 1rem;
            box-shadow: var(--shadow-light);
            max-width: 450px; /* Um pouco maior */
            width: 90%;
            text-align: center;
            transition: background-color 0.5s ease, color 0.5s ease, box-shadow 0.5s ease;
            backdrop-filter: blur(12px); /* Mais desfoque */
            border: 1px solid var(--card-border-light);
        }
        .dark .confirm-modal-content {
            background-color: var(--modal-bg-dark);
            color: var(--modal-text-dark);
            box-shadow: var(--shadow-dark);
            border: 1px solid var(--card-border-dark);
        }
        .confirm-modal-content h3 {
            color: var(--text-color-light);
            font-size: 1.5rem; /* Título maior */
        }
        .dark .confirm-modal-content h3 {
            color: var(--text-color-dark);
        }
        .confirm-modal-content p {
            color: #7f8c8d; /* Cor mais neutra */
            font-size: 1.1rem; /* Texto maior */
        }
        .dark .confirm-modal-content p {
            color: #bdc3c7;
        }

        /* Estilos para botões genéricos */
        .btn {
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.8rem 1.8rem; /* Mais padding */
            border-radius: 0.75rem; /* Mais arredondado */
            font-weight: 600;
            color: white;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15); /* Sombra mais forte */
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            border: none; /* Remover bordas padrão */
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        .btn:hover {
            transform: translateY(-3px); /* Efeito de elevação mais pronunciado */
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.25); /* Sombra no hover */
        }

        /* Efeito de brilho nos botões */
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 300%;
            height: 300%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%);
            transition: all 0.5s ease-out;
            transform: translate(-50%, -50%) scale(0);
            opacity: 0;
            z-index: -1;
        }

        .btn:hover::before {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
        }

        .btn-blue {
            background: linear-gradient(135deg, #3498db, #2980b9);
        }
        .btn-blue:hover {
            background: linear-gradient(135deg, #2980b9, #2c3e50);
        }

        .btn-red {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }
        .btn-red:hover {
            background: linear-gradient(135deg, #c0392b, #a93226);
        }

        .btn-gray {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        }
        .btn-gray:hover {
            background: linear-gradient(135deg, #7f8c8d, #6c7a89);
        }

        .btn-green {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
        }
        .btn-green:hover {
            background: linear-gradient(135deg, #27ae60, #1e8449);
        }
        .btn-primary { /* Para o botão "Gerar PDF" no romaneio */
            background: linear-gradient(135deg, var(--primary-500), var(--primary-700));
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-700), var(--primary-900));
        }
        .btn-warning {
            background: linear-gradient(135deg, #f1c40f, #f39c12);
        }
        .btn-warning:hover {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }


        /* Responsive adjustments */
        @media (max-width: 768px) {
            .modal-content {
                padding: 0;
                width: 100vw;
                height: 100vh;
                max-width: 100vw;
                max-height: 100vh;
                border-radius: 0;
            }
            .calculator-table th, .calculator-table td {
                padding: 0.3rem;
                font-size: 0.9rem;
            }
            .calculator-table input,
            .calculator-table select {
                font-size: 0.9rem;
                padding: 0.4rem;
            }
            #tabela {
                font-size: 0.8rem;
            }
            .invoice-table th, .invoice-table td {
                padding: 0.3rem;
                font-size: 0.9rem;
            }
            .invoice-table input,
            .invoice-table select {
                font-size: 0.9rem;
                padding: 0.4rem;
            }
            .calculator-table td:nth-child(8) input,
            .calculator-table td:nth-child(9) .currency-input input {
                font-size: 0.9rem;
                padding: 0.6rem;
                min-width: 80px;
            }
            .confirm-modal-content {
                padding: 1.5rem;
            }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
    <header class="bg-white shadow-md sticky top-0 z-50 dark:bg-gray-800 dark:shadow-lg transition-colors duration-300">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center">
                <i class="fas fa-tree text-3xl text-primary-500 mr-3 animate-pulse-slow"></i>
                <h1 class="text-2xl font-bold text-gray-800 dark:text-white">Setor Produtivo Florestal</h1>
            </div>
            <nav class="hidden md:flex space-x-8">
                <a href="#" class="nav-link active text-gray-800 font-medium dark:text-gray-200" data-tab="apps">Aplicativos</a>
            </nav>
            <button class="md:hidden text-gray-700 dark:text-gray-300" id="mobile-menu-button">
                <i class="fas fa-bars text-2xl"></i>
            </button>
        </div>
        <div class="md:hidden hidden bg-white shadow-lg dark:bg-gray-800" id="mobile-menu">
            <div class="container mx-auto px-4 py-3 flex flex-col space-y-3">
                <a href="#" class="nav-link active text-gray-800 font-medium py-2 dark:text-gray-200" data-tab="apps">Aplicativos</a>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">
        <div id="apps" class="tab-content active">
            <section class="forest-hero text-white py-16 px-4 rounded-lg mb-12">
                <div class="max-w-4xl mx-auto text-center">
                    <h1 class="text-4xl md:text-5xl font-bold mb-6 animate-glow" style="--accent-blue-neon: #00F0FF;">Aplicativos Florestais</h1>
                    <p class="text-xl md:text-2xl mb-8">Ferramentas desenvolvidas para profissionais do setor madeireiro</p>
					<p class="text-xl md:text-2xl mb-8">Francisco José (Romaneador & Classificador de Madeiras)</p>
                </div>
            </section>

            <div class="text-center mb-12">
                <h2 class="text-3xl font-bold text-gray-800 dark:text-white mb-4">Ferramentas Essenciais</h2>
                <p class="text-gray-600 dark:text-gray-300 max-w-2xl mx-auto">
                    Acelere suas operações com nossos aplicativos inteligentes, projetados para a eficiência no campo e no escritório.
                </p>
            </div>

            <div class="flex flex-wrap justify-center gap-8 mb-12 app-icons">
                <div class="app-icon p-6 text-center w-64 cursor-pointer transition" onclick="openModal('calculator-modal')">
                    <div class="bg-green-100 rounded-full p-4 inline-block mb-4">
                        <i class="fas fa-calculator text-4xl text-green-600"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-2">Calculadora de Volume</h3>
                    <p class="text-sm">
                        Calcule o volume de madeira em toras com precisão e gere relatórios detalhados.
                    </p>
                </div>

                <div class="app-icon p-6 text-center w-64 cursor-pointer transition" onclick="openModal('invoice-modal')">
                    <div class="bg-blue-100 rounded-full p-4 inline-block mb-4">
                        <i class="fas fa-file-invoice-dollar text-4xl text-blue-600"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-2">Gerador de Orçamento</h3>
                    <p class="text-sm">
                        Crie Orçamentos profissionais para seus clientes de forma rápida e organizada.
                    </p>
                </div>

                <div class="app-icon p-6 text-center w-64 cursor-pointer transition" onclick="openModal('romaneio-modal')">
                    <div class="bg-purple-100 rounded-full p-4 inline-block mb-4">
                        <i class="fas fa-boxes text-4xl text-purple-600"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-2">Romaneio de Madeira Serrada</h3>
                    <p class="text-sm">
                        Gerencie e organize o romaneio de madeira serrada com facilidade.
                    </p>
                </div>

                <div class="app-icon p-6 text-center w-64 cursor-pointer transition" onclick="openModal('resumo-pedidos-modal')">
                    <div class="bg-yellow-100 rounded-full p-4 inline-block mb-4">
                        <i class="fas fa-clipboard-list text-4xl text-yellow-600"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-2">Resumo de Pedidos</h3>
                    <p class="text-sm">
                        Crie e organize resumos de pedidos com detalhes financeiros e comentários.
                    </p>
                </div>
            </div>

            <div class="max-w-4xl mx-auto rounded-lg shadow-md p-8 mb-12 app-icon">
                <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-4">Como nossos aplicativos podem ajudar você</h3>
                <p class="text-gray-600 dark:text-gray-300 mb-6">
                    No setor florestal, a precisão nos cálculos e a organização documental são essenciais para o sucesso dos negócios. Nossas ferramentas foram desenvolvidas para:
                </p>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="flex items-start">
                        <div class="bg-green-100 p-3 rounded-full mr-4">
                            <i class="fas fa-check-circle text-green-600"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-800 dark:text-white mb-1">Otimizar processos</h4>
                            <p class="text-sm">Reduza o tempo gasto com cálculos manuais e aumente a produtividade.</p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <div class="bg-green-100 p-3 rounded-full mr-4">
                            <i class="fas fa-check-circle text-green-600"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-800 dark:text-white mb-1">Minimizar erros</h4>
                            <p class="text-sm">Cálculos automáticos eliminam erros humanos comuns.</p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <div class="bg-green-100 p-3 rounded-full mr-4">
                            <i class="fas fa-check-circle text-green-600"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-800 dark:text-white mb-1">Padronizar documentos</h4>
                            <p class="text-sm">Faturas, romaneios e relatórios profissionais e uniformes.</p>
                        </div>
                    </div>
                    <div class="flex items-start">
                        <div class="bg-green-100 p-3 rounded-full mr-4">
                            <i class="fas fa-check-circle text-green-600"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-gray-800 dark:text-white mb-1">Facilitar análises</h4>
                            <p class="text-sm">Resumos por espécie e totais calculados automaticamente.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="calculator-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center p-4 bg-gray-900 modal-header">
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-200">
                    <i class="fas fa-times text-2xl"></i>
                </button>
                <h2 class="text-4xl font-bold text-green-400 flex-grow text-center tracking-wider drop-shadow-lg">Calculadora de Volume-Francon</h2>
            </div>
            <div class="flex-1 overflow-auto p-2 md:p-6 bg-gray-900">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <div>
                        <p class="text-sm md:text-base text-gray-300">
                            Cálculo preciso para madeiras em toras
                        </p>
                    </div>
                    <div class="w-full md:w-auto flex flex-col md:flex-row gap-2">
                        <div class="flex flex-col mb-2 md:mb-0 md:mr-2 flex-1">
                            <label for="cliente" class="block text-sm font-medium text-gray-300 mb-1">Nome do Cliente:</label>
                            <input type="text" id="cliente" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-md focus:ring-green-500 focus:border-green-500 block w-full p-2 input-mobile modal-input" placeholder="Digite o nome do cliente">
                        </div>
                        <div class="flex flex-col mb-2 md:mb-0 md:mr-2 flex-1">
                            <label for="fornecedor" class="block text-sm font-medium text-gray-300 mb-1">Nome do Fornecedor:</label>
                            <input type="text" id="fornecedor" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-md focus:ring-green-500 focus:border-green-500 block w-full p-2 input-mobile modal-input" placeholder="Digite o nome do fornecedor">
                        </div>
                        <div class="flex flex-col flex-1">
                            <label for="tipo" class="block text-sm font-medium text-gray-300 mb-1">Tipo de Cálculo:</label>
                            <select id="tipo" onchange="calculator_calculate()" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-md focus:ring-green-500 focus:border-green-500 block w-full p-2 input-mobile modal-input">
                                <option value="1">Padrão</option>
                                <option value="2">Industrial</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="table-container overflow-x-auto scrollbar-hide rounded-lg border border-gray-700 bg-gray-800">
                    <table id="tabela" class="w-full text-sm text-left text-gray-300 calculator-table">
                        <thead class="text-xs text-gray-300 uppercase bg-gray-700">
                            <tr>
                                <th scope="col">Rodo (mm)</th>
                                <th scope="col">Comp (mm)</th>
                                <th scope="col">M³ (Bruto)</th>
                                <th scope="col">Ocos 1 (mm)</th>
                                <th scope="col">Ocos 2 (mm)</th>
                                <th scope="col">M³ (OCOS)</th>
                                <th scope="col">M³ (Liq.)</th>
                                <th scope="col">Espécies</th>
                                <th scope="col">Valor (R$)</th>
                                <th scope="col">Total (R$)</th>
                            </tr>
                        </thead>
                        <tbody id="linhas" class="divide-y divide-gray-700">
                        </tbody>
                    </table>
                </div>
                <div class="flex flex-wrap gap-3 mt-6">
                    <button onclick="calculator_adicionarLinha()" class="flex items-center gap-2 text-white bg-green-600 hover:bg-green-700 focus:ring-4 focus:ring-green-800 font-medium rounded-lg text-sm px-4 py-2 focus:outline-none transition btn">
                        <i class="fas fa-plus"></i>
                        <span class="hidden md:inline">Adicionar Linha</span>
                    </button>
                    <button onclick="calculator_calculate()" class="flex items-center gap-2 text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-800 font-medium rounded-lg text-sm px-4 py-2 focus:outline-none transition btn">
                        <i class="fas fa-calculator"></i>
                        <span class="hidden md:inline">Calcular</span>
                    </button>
                    <button onclick="calculator_gerarPDF()" class="flex items-center gap-2 text-white bg-red-600 hover:bg-red-700 focus:ring-4 focus:ring-red-800 font-medium rounded-lg text-sm px-4 py-2 focus:outline-none transition btn">
                        <i class="fas fa-file-pdf"></i>
                        <span class="hidden md:inline">Gerar PDF</span>
                    </button>
                    <button onclick="calculator_showConfirmClearModal()" class="flex items-center gap-2 text-white bg-gray-600 hover:bg-gray-700 focus:ring-4 focus:ring-gray-800 font-medium rounded-lg text-sm px-4 py-2 focus:outline-none transition btn">
                        <i class="fas fa-trash"></i>
                        <span class="hidden md:inline">Limpar Tudo</span>
                    </button>
                </div>
                <div id="totais" class="mt-6 p-4 bg-gray-700 rounded-lg">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                        <div class="bg-gray-800 p-3 rounded-lg">
                            <h3 class="text-sm font-medium text-gray-400 mb-1">Volume Líquido Total</h3>
                            <p class="text-xl md:text-2xl font-bold text-green-400"><span id="somaLiq">0,000</span> m³</p>
                        </div>
                        <div class="bg-gray-800 p-3 rounded-lg">
                            <h3 class="text-sm font-medium text-gray-400 mb-1">Valor Total</h3>
                            <p class="text-xl md:text-2xl font-bold text-blue-400">R$ <span id="somaTotal">0,00</span></p>
                        </div>
                    </div>
                    <div id="resumoEspecies" class="bg-gray-800 rounded-lg p-4">
                        <h3 class="text-sm font-medium text-gray-400 mb-2">Resumo por Espécie</h3>
                        <div id="listaEspecies" class="space-y-2">
                            <p class="text-gray-300 text-sm">Nenhuma espécie cadastrada ainda</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="invoice-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4 p-4 bg-gray-900 modal-header">
                <h2 class="text-4xl font-bold text-blue-400 flex-grow text-center tracking-wider drop-shadow-lg">Gerador de Orçamento</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-200">
                    <i class="fas fa-times text-2xl"></i>
                </button>
            </div>
            <div class="flex-1 overflow-auto p-2 md:p-6 bg-gray-100 dark:bg-gray-900" id="fatura">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label for="invoice-client" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">Cliente</label>
                        <input type="text" id="invoice-client" class="w-full p-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500 input-mobile modal-input" oninput="invoice_calculateInvoiceTotal()">
                    </div>
                    <div>
                        <label for="invoice-number" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">Número da Fatura</label>
                        <input type="text" id="invoice-number" class="w-full p-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500 input-mobile modal-input" oninput="invoice_calculateInvoiceTotal()">
                    </div>
                    <div>
                        <label for="invoice-date" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">Data</label>
                        <input type="date" id="invoice-date" class="w-full p-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500 input-mobile modal-input" oninput="invoice_calculateInvoiceTotal()">
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200 invoice-table bg-white rounded-lg shadow-md dark:bg-gray-700 dark:divide-gray-600">
                        <thead class="bg-gray-50 dark:bg-gray-800">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Quantidade</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Descrição</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Unidade</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Valor Unitário</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Total</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300"></th>
                            </tr>
                        </thead>
                        <tbody id="invoice-items" class="divide-y divide-gray-200 dark:divide-gray-600"></tbody>
                    </table>
                </div>
                <div class="flex justify-between mt-4">
                    <button onclick="invoice_addInvoiceRow()" class="bg-green-600 text-white px-4 py-2 rounded-md btn">
                        <i class="fas fa-plus"></i> Adicionar Item
                    </button>
                </div>
                <div class="mt-8 border-t border-gray-200 pt-4 dark:border-gray-600">
                    <div class="flex justify-end">
                        <div class="w-full md:w-1/3 text-gray-700 dark:text-gray-300">
                            <div class="flex justify-between mb-2">
                                <span class="font-medium">Subtotal:</span>
                                <span id="invoice-subtotal">R$ 0,00</span>
                            </div>
                            <div class="flex justify-between mb-2">
                                <span class="font-medium">Taxas:</span>
                                <input type="number" step="0.01" id="invoice-tax" value="0.00" oninput="invoice_calculateInvoiceTotal()" class="w-20 border border-gray-300 p-1 rounded-md modal-input">
                            </div>
                            <div class="flex justify-between mb-2">
                                <span class="font-medium">Descontos:</span>
                                <input type="number" step="0.01" id="invoice-discount" value="0.00" oninput="invoice_calculateInvoiceTotal()" class="w-20 border border-gray-300 p-1 rounded-md modal-input">
                            </div>
                            <div class="flex justify-between text-lg font-bold border-t border-gray-300 pt-2 mt-2 dark:border-gray-600">
                                <span>Total:</span>
                                <span id="invoice-total">R$ 0,00</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-8 flex justify-end gap-4">
                    <button onclick="invoice_showConfirmClearModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded-md btn">
                        Limpar
                    </button>
                    <button onclick="invoice_generateInvoicePDF()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md flex items-center gap-2 btn">
                        <i class="fas fa-file-pdf"></i> Gerar PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="romaneio-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center p-4 bg-gray-900 modal-header">
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-200">
                    <i class="fas fa-times text-2xl"></i>
                </button>
                <h2 class="text-4xl font-bold text-yellow-400 flex-grow text-center tracking-wider drop-shadow-lg">Romaneio de Madeira Serrada</h2>
            </div>
            <div class="flex-1 overflow-auto p-2 md:p-6 bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
                <div class="container mx-auto px-4 py-8 max-w-7xl">
                    <div class="flex flex-col lg:flex-row gap-6">
                        <div class="w-full lg:w-3/4">
                            <div class="card glass rounded-xl p-6 mb-6">
                                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                                    <div class="w-full">
                                        <h1 class="text-3xl font-bold text-gray-800 dark:text-white mb-1 text-center">Romaneio de Madeira Serrada</h1>
                                        <p class="text-gray-500 dark:text-gray-400 text-center">Sistema de controle e geração de romaneios para madeira serrada</p>
                                    </div>
                                    <div class="flex gap-2 flex-wrap items-center">
                                        <button id="romaneioClearLogoBtn" class="btn btn-danger hidden text-sm"><i class="fas fa-times mr-1"></i> Remover Logo</button>
                                        <label for="romaneioLogoUpload" class="btn btn-gray cursor-pointer text-sm"><i class="fas fa-image mr-1"></i> Add Logo</label>
                                        <input type="file" id="romaneioLogoUpload" accept="image/*" class="hidden">

                                        <label for="romaneioWatermarkUpload" id="romaneioWatermarkUploadLabel" class="btn btn-gray cursor-pointer text-sm"><i class="fas fa-tint mr-1"></i>Marca D'água</label>
                                        <input type="file" id="romaneioWatermarkUpload" accept="image/*" class="hidden">
                                        <button id="romaneioRemoveWatermarkBtn" class="btn btn-gray hidden text-sm"><i class="fas fa-times mr-1"></i> Remover Marca D'água</button>
                                    </div>
                                </div>

                                <div id="romaneioLogoContainer" class="mb-6 flex justify-start items-center gap-4 hidden animate-fade-in">
                                    <img id="romaneioLogoPreview" class="logo-preview" src="" alt="Logo">
                                </div>

                                <div id="romaneioWatermarkPreviewContainer" class="mb-6 flex justify-start items-center gap-4 hidden animate-fade-in">
                                    <span class="text-sm text-gray-600 dark:text-gray-300">Marca D'água:</span>
                                    <img id="romaneioWatermarkPreview" class="watermark-preview-img" src="" alt="Prévia Marca D'água">
                                </div>

                                <div class="mb-6">
                                    <label for="romaneioCliente" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Cliente</label>
                                    <div class="input-group">
                                        <span class="input-group-icon"><i class="fas fa-user"></i></span>
                                        <input type="text" id="romaneioCliente" class="input w-full modal-input" placeholder="Nome do cliente">
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4 items-end">
                                    <div class="md:col-span-1">
                                        <label for="romaneioEspecie" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Espécie <span class="text-danger-500">*</span></label>
                                        <div class="input-group">
                                            <span class="input-group-icon"><i class="fas fa-tree"></i></span>
                                            <input type="text" id="romaneioEspecie" class="input w-full modal-input" placeholder="Ex: Angelim" oninput="this.value = this.value.toUpperCase()">
                                        </div>
                                    </div>
                                    <div class="md:col-span-1">
                                        <label for="romaneioTipo" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tipo <span class="text-danger-500">*</span></label>
                                        <div class="input-group">
                                            <span class="input-group-icon"><i class="fas fa-shapes"></i></span>
                                            <select id="romaneioTipo" class="input w-full modal-input">
                                                <option value="">Selecione</option>
                                                <option value="BLOCO">BLOCO</option>
                                                <option value="CABRINHO">CABRINHO</option>
                                                <option value="CAIBRO">CAIBRO</option>
                                                <option value="PEÇA">PEÇA</option>
                                                <option value="PRANCHA">PRANCHA</option>
                                                <option value="RÉGUA">RÉGUA</option>
                                                <option value="RIPA">RIPA</option>
                                                <option value="RIPÃO">RIPÃO</option>
                                                <option value="TABUA">TÁBUA</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="md:col-span-1">
                                        <label for="romaneioPacote" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Pacote</label>
                                        <div class="input-group">
                                            <span class="input-group-icon"><i class="fas fa-box"></i></span>
                                            <input type="text" id="romaneioPacote" class="input w-full modal-input" placeholder="Opcional">
                                        </div>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 items-end">
                                    <div class="md:col-span-1">
                                        <label for="romaneioEspessura" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Espessura (mm) <span class="text-danger-500">*</span></label>
                                        <div class="input-group">
                                            <span class="input-group-icon"><i class="fas fa-ruler-vertical"></i></span>
                                            <input type="number" id="romaneioEspessura" class="input w-full modal-input" placeholder="mm">
                                        </div>
                                    </div>
                                    <div class="md:col-span-1">
                                        <label for="romaneioLargura" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Largura (mm) <span class="text-danger-500">*</span></label>
                                        <div class="input-group">
                                            <span class="input-group-icon"><i class="fas fa-ruler-horizontal"></i></span>
                                            <input type="number" id="romaneioLargura" class="input w-full modal-input" placeholder="mm">
                                        </div>
                                    </div>
                                    <div class="md:col-span-1">
                                        <label for="romaneioComprimento" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Comprimento (m) <span class="text-danger-500">*</span></label>
                                        <div class="flex items-center gap-2">
                                            <div class="input-group flex-1">
                                                <span class="input-group-icon"><i class="fas fa-ruler"></i></span>
                                                <input type="number" id="romaneioComprimento" class="input w-full modal-input" placeholder="m"> </div>
                                            <button id="romaneioAddComprimentoBtn" class="btn btn-gray text-sm !py-2 !px-3 flex-shrink-0 animate-bounce-slow"><i class="fas fa-plus mr-1"></i> Add</button>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-6">
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Quantidades por Comprimento <span class="text-danger-500">*</span></label>
                                    <div id="romaneioQuantidadesContainer" class="flex flex-wrap gap-4 p-4 bg-gray-50 dark:bg-gray-800 rounded-md border border-gray-200 dark:border-gray-700 min-h-[60px]">
                                        <p class="text-gray-400 dark:text-gray-500 text-sm self-center animate-pulse-slow">Adicione comprimentos para inserir quantidades.</p>
                                    </div>
                                </div>

                                <div class="mb-6">
                                    <label for="romaneioComentarios" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Comentários</label>
                                    <div class="input-group">
                                        <span class="input-group-icon"><i class="fas fa-comment"></i></span>
                                        <textarea id="romaneioComentarios" class="input w-full modal-input" rows="3" placeholder="Adicione observações ou detalhes adicionais"></textarea>
                                    </div>
                                </div>

                                <div class="flex flex-wrap gap-3 mb-6">
                                    <button id="romaneioAdicionarBtn" class="btn btn-green rounded-md"><i class="fas fa-plus-circle mr-1"></i> Add Item</button>
                                    <button id="romaneioLimparCamposBtn" class="btn btn-warning rounded-md"><i class="fas fa-undo mr-1"></i> Limpar</button>
                                    <button id="romaneioLimparTudoBtn" class="btn btn-red rounded-md"><i class="fas fa-eraser mr-1"></i> Deletar</button>
                                    <button id="romaneioPreviewPdfBtn" class="btn btn-blue rounded-md"><i class="fas fa-eye mr-1"></i> Preview PDF</button>
                                    <button id="romaneioGerarPdfBtn" class="btn btn-primary rounded-md"><i class="fas fa-file-pdf mr-1"></i> Gerar PDF</button>
                                </div>
                            </div>

                            <div class="card glass rounded-xl p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h2 class="text-xl font-bold text-gray-800 dark:text-white">Itens do Romaneio</h2>
                                    <span id="romaneioTotalItensBadge" class="badge badge-primary"><i class="fas fa-cubes mr-1"></i> <span id="romaneioTotalItensCount">0</span> itens</span>
                                </div>
                                <div class="table-container overflow-x-auto rounded-lg border border-gray-200 dark:border-gray-700">
                                    <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                        <thead class="bg-gray-50 dark:bg-gray-800">
                                            <tr id="romaneioTableHeaderRow"></tr>
                                        </thead>
                                        <tbody id="romaneioItensRomaneio" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                            <tr>
                                                <td colspan="8" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400"> Nenhum item no romaneio. Adicione itens para começar. </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="w-full lg:w-1/4 no-print">
                            <div class="card glass rounded-xl p-6 sidebar overflow-y-auto">
                                <div class="flex items-center gap-3 mb-6 pb-3 border-b border-gray-200 dark:border-gray-700">
                                    <div class="p-2 rounded-full bg-primary-100 dark:bg-primary-900 text-primary-600 dark:text-primary-300">
                                        <i class="fas fa-chart-pie text-lg"></i>
                                    </div>
                                    <h2 class="text-xl font-bold text-gray-800 dark:text-white">Resumo do Romaneio</h2>
                                </div>
                                <div class="mb-6">
                                    <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-3 flex items-center gap-2">
                                        <i class="fas fa-user text-primary-500"></i> Cliente
                                    </h3>
                                    <div id="romaneioResumoCliente" class="text-gray-600 dark:text-gray-400 bg-gray-50 dark:bg-gray-700 p-3 rounded-lg border border-gray-200 dark:border-gray-600">
                                        <span class="text-gray-400 dark:text-gray-500">Nenhum cliente informado</span>
                                    </div>
                                </div>
                                <div class="mb-6">
                                    <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-3 flex items-center gap-2">
                                        <i class="fas fa-cubes text-primary-500"></i> Quantidade Total
                                    </h3>
                                    <div id="romaneioResumoQuantidadeTotalGlobal" class="text-gray-800 dark:text-white bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border border-gray-200 dark:border-gray-600 text-center">
                                        <span class="block text-3xl font-bold gradient-text">0</span>
                                        <span class="text-sm text-gray-500 dark:text-gray-400">peças no total</span>
                                        <div class="mt-2 pt-2 border-t border-gray-200 dark:border-gray-700 text-xs">
                                            <div class="flex justify-between"><span>Total ML:</span><strong class="text-gray-800 dark:text-gray-200">0,00</strong></div>
                                            <div class="flex justify-between"><span>Total M³:</span><strong class="text-gray-800 dark:text-gray-200">0,000</strong></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-6">
                                    <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-3 flex items-center gap-2">
                                        <i class="fas fa-ruler-combined text-primary-500"></i> Totais Agrupados
                                    </h3>
                                    <div id="romaneioTotaisEspecie" class="space-y-3">
                                        <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border border-gray-200 dark:border-gray-600 text-center">
                                            <span class="text-gray-400 dark:text-gray-500">Nenhum item adicionado</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="romaneioEditModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 opacity-0 pointer-events-none modal">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md p-6 animate-slide-up">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-800 dark:text-white">Editar Item</h3>
                            <button id="romaneioCloseEditModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="space-y-4 overflow-y-auto max-h-[70vh] pr-2"> <input type="hidden" id="romaneioEditIndex">
                            <div>
                                <label for="romaneioEditTipo" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tipo</label>
                                <select id="romaneioEditTipo" class="input w-full modal-input">
                                    </select>
                            </div>
                            <div>
                                <label for="romaneioEditEspessura" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Espessura (mm)</label>
                                <input type="number" id="romaneioEditEspessura" class="input w-full modal-input">
                            </div>
                            <div>
                                <label for="romaneioEditLargura" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Largura (mm)</label>
                                <input type="number" id="romaneioEditLargura" class="input w-full modal-input">
                            </div>
                            <div>
                                <label for="romaneioEditEspecie" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Espécie</label>
                                <input type="text" id="romaneioEditEspecie" class="input w-full modal-input" oninput="this.value = this.value.toUpperCase()">
                            </div>
                            <div>
                                <label for="romaneioEditPacote" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Pacote</label>
                                <input type="text" id="romaneioEditPacote" class="input w-full modal-input">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Comprimento (m)</label>
                                <span id="romaneioEditComprimentoDisplay" class="input w-full block bg-gray-100 dark:bg-gray-700 cursor-not-allowed"></span>
                            </div>
                            <div>
                                <label for="romaneioEditQuantidade" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Quantidade</label>
                                <input type="number" id="romaneioEditQuantidade" class="input w-full modal-input">
                            </div>
                            <div class="flex justify-end gap-3 mt-6">
                                <button id="romaneioCancelEditBtn" class="btn btn-gray rounded-md">Cancelar</button>
                                <button id="romaneioSalvarEdicaoBtn" class="btn btn-blue rounded-md">Salvar Alterações</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="romaneioGroupActionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] opacity-0 pointer-events-none modal">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-xl p-6 animate-slide-up">
                        <div class="flex justify-between items-center mb-4">
                            <h3 id="romaneioGroupActionModalTitle" class="text-xl font-bold text-gray-800 dark:text-white">Detalhes do Grupo</h3>
                            <button id="romaneioCloseGroupActionModalBtn" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div id="romaneioGroupActionDetailsContainer" class="mt-4 space-y-2 max-h-[24rem] overflow-y-auto pr-2"></div>
                        <div class="flex justify-end mt-6">
                            <button id="romaneioCloseGroupActionModalFooterBtn" class="btn btn-gray rounded-md">Fechar</button>
                        </div>
                    </div>
                </div>

                <div id="romaneioConfirmClearModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70] opacity-0 pointer-events-none modal">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-sm p-6 animate-slide-up">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-gray-800 dark:text-white">Confirmar Limpeza Total</h3>
                            <button id="romaneioCloseConfirmClear" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <p class="text-gray-700 dark:text-gray-300 mb-6">Tem certeza de que deseja limpar *todos* os dados, incluindo romaneio, logo e marca d'água?</p>
                        <div class="flex justify-end gap-3">
                            <button id="romaneioCancelClearBtn" class="btn btn-gray rounded-md">Cancelar</button>
                            <button id="romaneioConfirmClearBtn" class="btn btn-red rounded-md">Limpar Tudo</button>
                        </div>
                    </div>
                </div>

                <div id="romaneioConfirmDeleteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[70] opacity-0 pointer-events-none modal">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-sm p-6 animate-slide-up">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-gray-800 dark:text-white">Confirmar Exclusão</h3>
                            <button id="romaneioCloseConfirmDelete" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <p class="text-gray-700 dark:text-gray-300 mb-6">Tem certeza de que deseja excluir este item?</p>
                        <div class="flex justify-end gap-3">
                            <button id="romaneioCancelDeleteBtn" class="btn btn-gray rounded-md">Cancelar</button>
                            <button id="romaneioConfirmDeleteBtn" class="btn btn-red rounded-md">Excluir</button>
                        </div>
                    </div>
                </div>

                <div id="romaneioPdfPreviewModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[80] opacity-0 pointer-events-none modal">
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-4xl h-[90%] p-6 flex flex-col animate-slide-up">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-gray-800 dark:text-white">Prévia do PDF</h3>
                            <button id="romaneioClosePdfPreviewModalBtn" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div id="romaneioPdfPreviewContainer" class="flex-grow flex items-center justify-center bg-gray-50 dark:bg-gray-700 rounded-lg overflow-hidden">
                            <iframe id="romaneioPdfPreviewIframe" class="w-full h-full" frameborder="0"></iframe>
                        </div>
                        <div class="flex justify-end mt-4">
                            <button id="romaneioDownloadPdfFromPreviewBtn" class="btn btn-blue rounded-md"><i class="fas fa-download mr-2"></i> Baixar PDF</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="resumo-pedidos-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center p-4 bg-gray-900 modal-header">
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-200">
                    <i class="fas fa-times text-2xl"></i>
                </button>
                <h2 class="text-4xl font-bold text-purple-neon flex-grow text-center tracking-wider drop-shadow-lg">Resumo de Pedido</h2>
            </div>
            <div class="flex-1 overflow-auto p-2 md:p-6 bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
                <div class="container mx-auto px-4 py-8">
                    <div class="bg-white rounded-xl shadow-xl p-6 mb-8 relative overflow-hidden dark:bg-gray-800 dark:shadow-lg">
                        <div id="resumoPedidosWatermarkContainer"></div>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                            <div>
                                <label class="block text-gray-700 font-medium mb-2 dark:text-gray-300">Nome do Cliente</label>
                                <input type="text" id="resumoPedidosNomeCliente" class="w-full px-4 py-3 border rounded-md focus:outline-none input-focus-effect modal-input">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-medium mb-2 dark:text-gray-300">Quantidade <span class="text-red-500">*</span></label>
                                <input type="number" id="resumoPedidosQuantidade" class="w-full px-4 py-3 border rounded-md focus:outline-none input-focus-effect modal-input" min="0" step="0.01" required>
                            </div>

                            <div>
                                <label class="block text-gray-700 font-medium mb-2 dark:text-gray-300">Unidade de Medida <span class="text-red-500">*</span></label>
                                <select id="resumoPedidosUnidade" class="w-full px-4 py-3 border rounded-md focus:outline-none input-focus-effect modal-input" required>
                                    <option value="ml">ml</option>
                                    <option value="m²">m²</option>
                                    <option value="m³">m³</option>
                                    <option value="un">un</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-gray-700 font-medium mb-2 dark:text-gray-300">Descrição <span class="text-red-500">*</span></label>
                                <input type="text" id="resumoPedidosDescricao" class="w-full px-4 py-3 border rounded-md focus:outline-none input-focus-effect modal-input" required>
                            </div>

                            <div>
                                <label class="block text-gray-700 font-medium mb-2 dark:text-gray-300">Valor Unitário (R$) <span class="text-red-500">*</span></label>
                                <input type="text" id="resumoPedidosValorUnitario" class="w-full px-4 py-3 border rounded-md focus:outline-none input-focus-effect modal-input" value="0,00">
                            </div>

                            <div>
                                <label class="block text-gray-700 font-medium mb-2 dark:text-gray-300">Adiantamento (R$)</label>
                                <input type="text" id="resumoPedidosAdiantamento" class="w-full px-4 py-3 border rounded-md focus:outline-none input-focus-effect modal-input" value="0,00">
                            </div>

                            <div>
                                <label class="block text-gray-700 font-medium mb-2 dark:text-gray-300">Desconto (R$)</label>
                                <input type="text" id="resumoPedidosDesconto" class="w-full px-4 py-3 border rounded-md focus:outline-none input-focus-effect modal-input" value="0,00">
                            </div>

                            <div class="lg:col-span-3">
                                <label class="block text-gray-700 font-medium mb-2 dark:text-gray-300">Comentários / Dados Bancários</label>
                                <textarea id="resumoPedidosComentarios" class="w-full px-4 py-3 border rounded-md focus:outline-none input-focus-effect modal-input" rows="3" placeholder="Ex: PIX: 123.456.789-00, Banco ABC, Ag. 1234, C/C 56789-0"></textarea>
                            </div>

                            <div class="lg:col-span-3">
                                <label class="block text-gray-700 font-medium mb-2 dark:text-gray-300">Dados da Empresa (Rodapé PDF)</label>
                                <textarea id="resumoPedidosDadosEmpresaRodape" class="w-full px-4 py-3 border rounded-md focus:outline-none input-focus-effect modal-input" rows="3">Serraria Oliveira - Rodovia BR-230 - Transamazônica, s/n, Estrada São Joaquim, Bairro Liberdade, Altamira/PA</textarea>
                            </div>
                        </div>

                        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                            <div>
                                <label class="block text-gray-700 font-medium mb-2 text-lg dark:text-gray-300">Subtotal: <span class="font-bold text-blue-600">R$ <span id="resumoPedidosSubtotalDisplay">0,00</span></span></label>
                                <label class="block text-gray-700 font-medium mb-2 text-lg dark:text-gray-300">Total a Pagar: <span class="font-bold text-green-600">R$ <span id="resumoPedidosValorFinal">0,00</span></span></label>
                            </div>

                            <div class="flex flex-wrap gap-3">
                                <input type="file" id="resumoPedidosLogoFileInput" accept="image/*" class="hidden">
                                <button id="resumoPedidosAddLogo" class="btn btn-gray rounded-md">
                                    <i class="fas fa-image"></i> Inserir Logo
                                </button>
                                <button id="resumoPedidosSalvar" class="btn btn-blue rounded-md">
                                    <i class="fas fa-save"></i> Salvar Pedido
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-xl p-6 dark:bg-gray-800 dark:shadow-lg">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                            <h2 class="text-2xl font-bold text-gray-800 dark:text-white">Pedidos Registrados</h2>

                            <div class="flex flex-wrap gap-3">
                                <button id="resumoPedidosExportPdf" class="btn btn-red rounded-md">
                                    <i class="fas fa-file-pdf"></i> Exportar para PDF
                                </button>
                                <button id="resumoPedidosClearOrders" class="btn btn-green rounded-md">
                                    <i class="fas fa-eraser"></i> Limpar Pedidos
                                </button>
                            </div>
                        </div>

                        <div class="table-container overflow-y-auto max-h-96"> <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
                                <thead class="bg-gray-50 sticky top-0 z-10 dark:bg-gray-700">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Cliente</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Quantidade</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Unidade</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Descrição</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Valor Unitário</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Subtotal</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Adiantamento</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Desconto</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Total a Pagar</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="resumoPedidosList" class="bg-white divide-y divide-gray-200 dark:bg-gray-800 dark:divide-gray-700">
                                </tbody>
                            </table>
                        </div>

                        <div class="mt-4 text-sm text-gray-500 dark:text-gray-400">
                            <p><span class="text-red-500">*</span> Campos obrigatórios</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div id="genericConfirmModal" class="confirm-modal">
        <div class="confirm-modal-content">
            <h3 id="confirmModalTitle" class="text-lg font-bold mb-4">Confirmar Ação</h3>
            <p id="confirmModalMessage" class="text-gray-700 mb-6">Você tem certeza que deseja realizar esta ação?</p>
            <div class="flex justify-center gap-4">
                <button id="cancelConfirmBtn" class="btn btn-gray rounded-md">Cancelar</button>
                <button id="confirmActionBtn" class="btn btn-red rounded-md">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="toastContainer" class="fixed bottom-4 right-4 z-[100]"></div>

    <button id="themeToggle" class="theme-toggle">
        <i class="fas fa-sun text-xl"></i>
    </button>

    <footer class="bg-gray-800 text-white py-8 dark:bg-gray-900 transition-colors duration-300">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <div class="flex items-center">
                        <i class="fas fa-tree text-2xl text-primary-400 mr-2"></i>
                        <span class="text-xl font-bold">Setor Produtivo Florestal</span>
                    </div>
                    <p class="text-gray-400 mt-2">Soluções completas para serrarias e madeireiras</p>
                </div>
                <div class="flex space-x-4">
                    <a href="https://wa.me/5593991394918" target="_blank" class="text-gray-400 hover:text-green-400">
                        <i class="fab fa-whatsapp text-2xl"></i>
                    </a>
                    <a href="https://www.linkedin.com/in/francisco-josé-702065229" target="_blank" class="text-gray-400 hover:text-blue-400">
                        <i class="fab fa-linkedin-in text-2xl"></i>
                    </a>
                    <a href="https://www.facebook.com/profile.php?id=100093255643114" target="_blank" class="text-gray-400 hover:text-blue-500">
                        <i class="fab fa-facebook-f text-2xl"></i>
                    </a>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-6 text-center text-gray-400">
                <p>&copy; 2025 Francisco José - Setor Produtivo Florestal. Todos os direitos reservados.</p>
            </div>
        </div>
    </footer>

    <script>
        // Variáveis globais
        const htmlElement = document.documentElement;
        let confirmCallback = null; // Callback para o modal de confirmação genérico

        // --- Funções de Utilitário Comuns ---

        /**
         * Exibe uma mensagem de toast na tela.
         * @param {string} message - A mensagem a ser exibida.
         * @param {string} type - O tipo de mensagem (success, danger, warning, info).
         */
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${getToastColor(type)} animate-fade-in`;
            toast.innerHTML = `
                <div class="flex items-center">
                    <i class="${getToastIcon(type)} mr-2"></i>
                    <span>${message}</span>
                </div>
            `;

            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('opacity-0');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 5000);
        }

        function getToastColor(type) {
            switch(type) {
                case 'success': return 'bg-success-500';
                case 'danger': return 'bg-danger-500';
                case 'warning': return 'bg-warning-500';
                case 'info': return 'bg-info-500';
                default: return 'bg-info-500';
            }
        }

        function getToastIcon(type) {
            switch(type) {
                case 'success': return 'fas fa-check-circle';
                case 'danger': return 'fas fa-exclamation-circle';
                case 'warning': return 'fas fa-exclamation-triangle';
                case 'info': return 'fas fa-info-circle';
                default: return 'fas fa-info-circle';
            }
        }

        /**
         * Exibe um modal de confirmação genérico.
         * @param {string} title - Título do modal.
         * @param {string} message - Mensagem do modal.
         * @param {function} callback - Função a ser executada se o usuário confirmar.
         * @param {string} confirmText - Texto do botão de confirmação (opcional).
         * @param {string} cancelText - Texto do botão de cancelar (opcional).
         */
        function showConfirmModal(title, message, callback, confirmText = 'Confirmar', cancelText = 'Cancelar') {
            document.getElementById('confirmModalTitle').textContent = title;
            document.getElementById('confirmModalMessage').textContent = message;
            document.getElementById('confirmActionBtn').textContent = confirmText;
            document.getElementById('cancelConfirmBtn').textContent = cancelText;

            confirmCallback = callback;

            const modal = document.getElementById('genericConfirmModal');
            modal.classList.add('active');
            modal.classList.toggle('dark', htmlElement.classList.contains('dark'));
        }

        /**
         * Fecha o modal de confirmação genérico.
         */
        function closeConfirmModal() {
            const modal = document.getElementById('genericConfirmModal');
            modal.classList.remove('active');
            confirmCallback = null;
        }

        // Event listeners para o modal de confirmação genérico
        document.getElementById('confirmActionBtn').addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback();
            }
            closeConfirmModal();
        });

        document.getElementById('cancelConfirmBtn').addEventListener('click', () => {
            closeConfirmModal();
        });


        // --- Funções da Página Principal (Aplicativos) ---

        // Funcionalidade de abas
        document.querySelectorAll('[data-tab]').forEach(tab => {
            tab.addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
                this.classList.add('active');
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById(this.dataset.tab).classList.add('active');
            });
        });

        // Alternar menu mobile
        document.getElementById('mobile-menu-button').addEventListener('click', function() {
            const menu = document.getElementById('mobile-menu');
            menu.classList.toggle('hidden');
        });

        // Funções de modal (abrir/fechar)
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('active');
            modal.classList.toggle('dark', htmlElement.classList.contains('dark')); // Sincroniza o tema do modal

            // Inicializa a aplicação quando o modal é aberto
            if (modalId === 'calculator-modal') calculator_initializeCalculator();
            if (modalId === 'invoice-modal') invoice_initializeInvoice();
            if (modalId === 'romaneio-modal') romaneio_initializeRomaneio();
            if (modalId === 'resumo-pedidos-modal') resumoPedidos_initializeResumoPedidos();
        }

        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('active');
            });
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                // Only close if the click is directly on the modal overlay, not its content
                if (event.target.id === 'calculator-modal' || event.target.id === 'invoice-modal' ||
                    event.target.id === 'romaneio-modal' || event.target.id === 'resumo-pedidos-modal' ||
                    event.target.id === 'genericConfirmModal' || event.target.id === 'romaneioEditModal' ||
                    event.target.id === 'romaneioGroupActionModal' || event.target.id === 'romaneioConfirmClearModal' ||
                    event.target.id === 'romaneioConfirmDeleteModal' || event.target.id === 'romaneioPdfPreviewModal') {
                    closeModal();
                }
            }
        }

        // Lógica de alternância de tema
        document.addEventListener('DOMContentLoaded', function() {
            const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
            if (localStorage.getItem('theme') === 'dark' || (localStorage.getItem('theme') === null && prefersDarkScheme.matches)) {
                htmlElement.classList.add('dark');
                // document.getElementById('themeToggle').classList.remove('fab-primary'); // Removido, pois o estilo é feito por CSS puro
                // document.getElementById('themeToggle').classList.add('fab-dark'); // Removido
                document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun text-xl"></i>';
            } else {
                htmlElement.classList.remove('dark');
                // document.getElementById('themeToggle').classList.remove('fab-dark'); // Removido
                // document.getElementById('themeToggle').classList.add('fab-primary'); // Removido
                document.getElementById('themeToggle').innerHTML = '<i class="fas fa-moon text-xl"></i>';
            }
        });

        document.getElementById('themeToggle').addEventListener('click', function() {
            const isDark = htmlElement.classList.toggle('dark');
            if (isDark) {
                localStorage.setItem('theme', 'dark');
                // this.classList.remove('fab-primary'); // Removido
                // this.classList.add('fab-dark'); // Removido
                this.innerHTML = '<i class="fas fa-sun text-xl"></i>';
            } else {
                localStorage.setItem('theme', 'light');
                // this.classList.remove('fab-dark'); // Removido
                // this.classList.add('fab-primary'); // Removido
                this.innerHTML = '<i class="fas fa-moon text-xl"></i>';
            }
        });

        // --- Funções da Calculadora de Volume (Prefixadas com 'calculator_') ---
        function calculator_initializeCalculator() {
            const tbody = document.getElementById("linhas");
            if (tbody.children.length === 0) {
                for (let i = 0; i < 5; i++) calculator_adicionarLinha();
            }
            calculator_calculate(); // Recalcula ao abrir
        }

        function calculator_adicionarLinha() {
            const tbody = document.getElementById("linhas");
            const tr = document.createElement("tr");
            tr.className = "bg-gray-800 hover:bg-gray-750";
            tr.innerHTML = `
            <td><input type="number" class="rodo bg-gray-700 border border-gray-600 text-white text-sm rounded-md focus:ring-green-500 focus:border-green-500 block w-full p-2 input-mobile modal-input" oninput="calculator_calculate()" placeholder="0"></td>
            <td><input type="number" class="comp bg-gray-700 border border-gray-600 text-white text-sm rounded-md focus:ring-green-500 focus:border-green-500 block w-full p-2 input-mobile modal-input" oninput="calculator_calculate()" placeholder="0"></td>
            <td class="m3bruto font-medium">0,000</td>
            <td><input type="number" class="oco1 bg-gray-700 border border-gray-600 text-white text-sm rounded-md focus:ring-green-500 focus:border-green-500 block w-full p-2 input-mobile modal-input" oninput="calculator_calculate()" placeholder="0"></td>
            <td><input type="number" class="oco2 bg-gray-700 border border-gray-600 text-white text-sm rounded-md focus:ring-green-500 focus:border-green-500 block w-full p-2 input-mobile modal-input" oninput="calculator_calculate()" placeholder="0"></td>
            <td class="m3oco font-medium">0,000</td>
            <td class="m3liq font-medium">0,000</td>
            <td><input type="text" class="especie bg-gray-700 border border-gray-600 text-white text-sm rounded-md focus:ring-green-500 focus:border-green-500 block w-full p-2 input-mobile modal-input" placeholder="Espécie"></td>
            <td><div class="currency-input"><input type="number" step="0.01" class="valor bg-gray-700 border border-gray-600 text-white text-sm rounded-md focus:ring-green-500 focus:border-green-500 block w-full p-2 input-mobile modal-input" oninput="calculator_calculate()" placeholder="0,00"></div></td>
            <td class="total font-bold">R$ 0,00</td>
            `;
            tbody.appendChild(tr);
        }

        function calculator_limparTabela() {
            const tbody = document.getElementById("linhas");
            tbody.innerHTML = "";
            document.getElementById("somaLiq").textContent = "0,000";
            document.getElementById("somaTotal").textContent = "0,00";
            document.getElementById("cliente").value = "";
            document.getElementById("fornecedor").value = "";
            calculator_atualizarResumoEspecies({});
            for (let i = 0; i < 5; i++) calculator_adicionarLinha();
            showToast('Tabela da calculadora limpa!', 'success');
        }

        function calculator_showConfirmClearModal() {
            showConfirmModal(
                'Confirmar Limpeza',
                'Tem certeza que deseja limpar toda a tabela da calculadora? Todos os dados serão perdidos.',
                calculator_limparTabela,
                'Limpar Tudo',
                'Cancelar'
            );
        }

        function calculator_calculate() {
            const tipo = document.getElementById("tipo").value;
            const linhas = document.querySelectorAll("#linhas tr");
            let somaLiq = 0, somaValor = 0;
            const resumoEspecies = {};

            linhas.forEach((linha) => {
                const rodo = parseFloat(linha.querySelector(".rodo").value) || 0;
                const comp = parseFloat(linha.querySelector(".comp").value) || 0;
                const oco1 = parseFloat(linha.querySelector(".oco1").value) || 0;
                const oco2 = parseFloat(linha.querySelector(".oco2").value) || 0;
                const valor = parseFloat(linha.querySelector(".valor").value) || 0;
                const especie = linha.querySelector(".especie").value.trim() || "Sem espécie";

                let rodoDiv = rodo / 4000;
                let compM = comp;
                if (tipo === "2") rodoDiv = Math.floor(rodoDiv * 1000) / 1000;

                const m3bruto = Math.pow(rodoDiv, 2) * compM;
                const m3oco = (oco1 / 1000) * (oco2 / 1000) * compM;
                const m3liq = m3bruto - m3oco;
                const total = m3liq * valor;

                linha.querySelector(".m3bruto").textContent = m3bruto.toFixed(3).replace(".", ",");
                linha.querySelector(".m3oco").textContent = m3oco.toFixed(3).replace(".", ",");

                const m3liqCell = linha.querySelector(".m3liq");
                m3liqCell.textContent = m3liq.toFixed(3).replace(".", ",");

                if (m3liq < 0) {
                    m3liqCell.classList.add("negative-volume");
                    m3liqCell.classList.remove("positive-volume");
                } else if (m3liq > 0) {
                    m3liqCell.classList.add("positive-volume");
                    m3liqCell.classList.remove("negative-volume");
                } else {
                    m3liqCell.classList.remove("positive-volume", "negative-volume");
                }

                linha.querySelector(".total").textContent = `R$ ${total.toFixed(2).replace(".", ",")}`;
                somaLiq += m3liq > 0 ? m3liq : 0;
                somaValor += total > 0 ? total : 0;

                if (m3liq > 0) {
                    if (!resumoEspecies[especie]) resumoEspecies[especie] = { toras: 0, volume: 0, valor: 0 };
                    resumoEspecies[especie].toras += 1;
                    resumoEspecies[especie].volume += m3liq;
                    resumoEspecies[especie].valor += total;
                }
            });

            document.getElementById("somaLiq").textContent = somaLiq.toFixed(3).replace(".", ",");
            document.getElementById("somaTotal").textContent = somaValor.toFixed(2).replace(".", ",");
            calculator_atualizarResumoEspecies(resumoEspecies);
        }

        function calculator_atualizarResumoEspecies(resumo) {
            const listaEspecies = document.getElementById("listaEspecies");
            listaEspecies.innerHTML = "";

            if (Object.keys(resumo).length === 0) {
                listaEspecies.innerHTML = '<p class="text-gray-600 text-sm">Nenhuma espécie cadastrada ainda</p>';
                return;
            }

            for (const [especie, dados] of Object.entries(resumo)) {
                const item = document.createElement("div");
                item.className = "resumo-especie p-3 rounded-lg mb-2";
                item.innerHTML = `
                <p class="font-medium text-green-600">${especie}</p>
                <div class="grid grid-cols-3 gap-2 text-sm mt-2">
                    <span class="text-gray-700">${dados.toras} tora${dados.toras !== 1 ? "s" : ""}</span>
                    <span class="text-gray-700">${dados.volume.toFixed(3).replace(".", ",")} m³</span>
                    <span class="text-gray-700">R$ ${dados.valor.toFixed(2).replace(".", ",")}</span>
                </div>
                `;
                listaEspecies.appendChild(item);
            }
        }

        function calculator_gerarPDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.setFontSize(18);
                doc.setTextColor(34, 197, 94);
                doc.text("Relatório de Volume de Madeira", 105, 15, { align: 'center' });

                const cliente = document.getElementById("cliente").value;
                const fornecedor = document.getElementById("fornecedor").value;

                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);

                let yPos = 25;
                if (cliente) {
                    doc.text(`Cliente: ${cliente}`, 14, yPos);
                    yPos += 7;
                }
                if (fornecedor) {
                    doc.text(`Fornecedor: ${fornecedor}`, 14, yPos);
                    yPos += 7;
                }

                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);

                const now = new Date();
                doc.text(`Gerado em: ${now.toLocaleDateString()} às ${now.toLocaleTimeString()}`, 14, yPos);
                yPos += 7;

                const tipo = document.getElementById("tipo");
                const tipoText = tipo.options[tipo.selectedIndex].text;
                doc.text(`Tipo de cálculo: ${tipoText}`, 14, yPos);
                yPos += 10;

                const head = [
                    ["Rodo (mm)", "Comp (mm)", "M³ Bruto", "Ocos 1 (mm)", "Ocos 2 (mm)", "M³ Ocos", "M³ Liq.", "Espécie", "Valor (R$)", "Total (R$)"]
                ];

                const body = [];
                const linhas = document.querySelectorAll("#linhas tr");
                linhas.forEach((tr) => {
                    body.push([
                        tr.querySelector(".rodo").value || "0",
                        tr.querySelector(".comp").value || "0",
                        tr.querySelector(".m3bruto").textContent,
                        tr.querySelector(".oco1").value || "0",
                        tr.querySelector(".oco2").value || "0",
                        tr.querySelector(".m3oco").textContent,
                        tr.querySelector(".m3liq").textContent,
                        tr.querySelector(".especie").value || "-",
                        tr.querySelector(".valor").value || "0,00",
                        tr.querySelector(".total").textContent,
                    ]);
                });

                doc.autoTable({
                    head: head,
                    body: body,
                    startY: yPos,
                    theme: "grid",
                    headStyles: {
                        fillColor: [55, 65, 81],
                        textColor: [255, 255, 255],
                        fontStyle: "bold",
                    },
                    alternateRowStyles: {
                        fillColor: [243, 244, 246],
                        textColor: [0, 0, 0],
                    },
                    styles: {
                        cellPadding: 3,
                        fontSize: 8,
                        overflow: "linebreak",
                    },
                    margin: { left: 10, right: 10 }
                });

                const somaLiq = document.getElementById("somaLiq").textContent;
                const somaTotal = document.getElementById("somaTotal").textContent;

                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text(`Volume Líquido Total: ${somaLiq} m³`, 14, doc.lastAutoTable.finalY + 10);
                doc.text(`Valor Total: ${somaTotal}`, 14, doc.lastAutoTable.finalY + 16);

                const resumoEspecies = document.getElementById("listaEspecies").children;
                if (resumoEspecies.length > 0 && !resumoEspecies[0].textContent.includes("Nenhuma")) {
                    doc.setFontSize(12);
                    doc.setTextColor(34, 197, 94);
                    doc.text("Resumo por Espécie:", 14, doc.lastAutoTable.finalY + 24);

                    let yPosSpecies = doc.lastAutoTable.finalY + 30;
                    for (let i = 0; i < resumoEspecies.length; i++) {
                        const especie = resumoEspecies[i].querySelector("p").textContent;
                        const dados = resumoEspecies[i].querySelectorAll("span");

                        doc.setFontSize(10);
                        doc.setTextColor(0, 0, 0);
                        doc.text(`${especie}: ${dados[0].textContent}, ${dados[1].textContent}, ${dados[2].textContent}`, 14, yPosSpecies);
                        yPosSpecies += 6;

                        if (yPosSpecies > doc.internal.pageSize.height - 20) {
                            doc.addPage();
                            yPosSpecies = 20;
                        }
                    }
                }

                doc.setFontSize(8);
                doc.setTextColor(100, 100, 100);
                doc.text("Francisco José - Calculadora de Volume - Altamira-PA © " + now.getFullYear(), 10, doc.internal.pageSize.height - 10, { align: 'left' });

                doc.save(`relatorio-volume-${cliente ? cliente.replace(/\s+/g, "-") + "-" : ""}${now.getTime()}.pdf`);
                showToast('PDF da calculadora gerado com sucesso!', 'success');
            } catch (error) {
                showToast("Erro ao gerar PDF da calculadora: " + error.message, 'danger');
            }
        }

        // --- Funções do Gerador de Orçamento (Prefixadas com 'invoice_') ---
        function invoice_initializeInvoice() {
            if (document.getElementById('invoice-items').children.length === 0) {
                invoice_addInvoiceRow();
            }
            invoice_calculateInvoiceTotal(); // Recalcula ao abrir
        }

        function invoice_addInvoiceRow() {
            const tbody = document.getElementById("invoice-items");
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td class="p-2"><input type="number" class="invoice-qty w-full p-1 border border-gray-300 rounded-md input-mobile modal-input dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200" oninput="invoice_calculateInvoiceRow(this)"></td>
                <td class="p-2"><input type="text" class="invoice-desc w-full p-1 border border-gray-300 rounded-md input-mobile modal-input dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200"></td>
                <td class="p-2">
                    <select class="invoice-unit w-full p-1 border border-gray-300 rounded-md input-mobile modal-input dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
                        <option value="ml">ml</option>
                        <option value="m²">m²</option>
                        <option value="m³">m³</option>
                        <option value="un">un</option>
                        <option value="kg">kg</option>
                    </select>
                </td>
                <td class="p-2">
                    <div class="currency-input">
                        <input type="text" class="invoice-unit-price w-full p-1 border border-gray-300 rounded-md input-mobile modal-input dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200" value="0,00" oninput="invoice_calculateInvoiceRow(this)">
                    </div>
                </td>
                <td class="p-2"><span class="invoice-total text-gray-800 dark:text-gray-200">R$ 0,00</span></td>
                <td class="p-2">
                    <button onclick="invoice_removeInvoiceRow(this)" class="text-red-600 hover:text-red-800">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(tr);

            // Add event listeners for currency input formatting on new row
            const newRowUnitPriceInput = tr.querySelector('.invoice-unit-price');
            newRowUnitPriceInput.addEventListener('focus', (e) => {
                e.target.value = invoice_parseCurrency(e.target.value).toFixed(2);
            });
            newRowUnitPriceInput.addEventListener('blur', (e) => {
                e.target.value = invoice_formatCurrency(parseFloat(e.target.value) || 0);
                invoice_calculateInvoiceRow(e.target);
            });
        }

        function invoice_removeInvoiceRow(button) {
            const row = button.closest('tr');
            row.remove();
            invoice_calculateInvoiceTotal();
        }

        function invoice_calculateInvoiceRow(input) {
            const row = input.closest('tr');
            const qty = parseFloat(row.querySelector('.invoice-qty').value) || 0;
            const unitPrice = invoice_parseCurrency(row.querySelector('.invoice-unit-price').value);
            const total = qty * unitPrice;
            row.querySelector('.invoice-total').textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
            invoice_calculateInvoiceTotal();
        }

        function invoice_calculateInvoiceTotal() {
            const rows = document.querySelectorAll('#invoice-items tr');
            let subtotal = 0;

            rows.forEach(row => {
                const totalText = row.querySelector('.invoice-total').textContent;
                const total = parseFloat(totalText.replace('R$', '').replace(',', '.')) || 0;
                subtotal += total;
            });

            const taxInput = document.getElementById('invoice-tax');
            const tax = parseFloat(taxInput.value.replace(',', '.')) || 0;

            const discountInput = document.getElementById('invoice-discount');
            const discount = parseFloat(discountInput.value.replace(',', '.')) || 0;

            const total = subtotal + tax - discount;

            document.getElementById('invoice-subtotal').textContent = `R$ ${subtotal.toFixed(2).replace('.', ',')}`;
            document.getElementById('invoice-total').textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
        }

        function invoice_clearInvoice() {
            document.getElementById('invoice-client').value = '';
            document.getElementById('invoice-number').value = '';
            document.getElementById('invoice-date').value = '';
            document.getElementById('invoice-tax').value = '0.00';
            document.getElementById('invoice-discount').value = '0.00';

            const tbody = document.getElementById('invoice-items');
            tbody.innerHTML = '';
            invoice_addInvoiceRow();

            document.getElementById('invoice-subtotal').textContent = 'R$ 0,00';
            document.getElementById('invoice-total').textContent = 'R$ 0,00';
            showToast('Orçamento limpo!', 'success');
        }

        function invoice_showConfirmClearModal() {
            showConfirmModal(
                'Confirmar Limpeza',
                'Tem certeza que deseja limpar todo o orçamento? Todos os dados serão perdidos.',
                invoice_clearInvoice,
                'Limpar Tudo',
                'Cancelar'
            );
        }

        function invoice_formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        function invoice_parseCurrency(text) {
            // Remove 'R$', dots for thousands, and replace comma with dot for decimals
            return parseFloat(text.replace('R$', '').replace(/\./g, '').replace(',', '.') || 0);
        }

        function invoice_formatDate(dateString) {
            if (!dateString) return '--/--/----';
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }

        function invoice_generateInvoicePDF() {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.setProperties({
                    title: `Orçamento ${document.getElementById('invoice-number').value || ''}`,
                    subject: 'Fatura de produtos florestais',
                    author: 'Setor Produtivo Florestal',
                    keywords: 'fatura, madeira, serraria',
                    creator: 'Francisco José'
                });

                doc.setFontSize(20);
                doc.setTextColor(32, 55, 100);
                doc.text("ORÇAMENTO", 105, 20, { align: 'center' });

                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);

                const clientName = document.getElementById('invoice-client').value || 'Cliente não informado';
                const invoiceNumber = document.getElementById('invoice-number').value || '---';
                const invoiceDate = document.getElementById('invoice-date').value || new Date().toISOString().split('T')[0];

                doc.text(`Número: ${invoiceNumber}`, 15, 50);
                doc.text(`Data: ${invoice_formatDate(invoiceDate)}`, 15, 55);
                doc.text(`Cliente: ${clientName}`, 15, 60);

                const headers = ["Qtd", "Descrição", "Unidade", "Valor Unitário", "Total"];
                const rows = [];

                document.querySelectorAll('#invoice-items tr').forEach(row => {
                    rows.push([
                        row.querySelector('.invoice-qty').value || '0',
                        row.querySelector('.invoice-desc').value || '',
                        row.querySelector('.invoice-unit').value || '',
                        `R$ ${invoice_formatCurrency(invoice_parseCurrency(row.querySelector('.invoice-unit-price').value))}`,
                        row.querySelector('.invoice-total').textContent || 'R$ 0,00'
                    ]);
                });

                doc.autoTable({
                    head: [headers],
                    body: rows,
                    startY: 70,
                    margin: { left: 15, right: 15 },
                    headStyles: {
                        fillColor: [32,55,100],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    alternateRowStyles: {
                        fillColor: [221,235,247]
                    },
                    styles: {
                        cellPadding: 3,
                        fontSize: 10
                    }
                });

                const subtotal = document.getElementById('invoice-subtotal').textContent;
                const tax = `R$ ${invoice_formatCurrency(invoice_parseCurrency(document.getElementById('invoice-tax').value))}`;
                const discount = `R$ ${invoice_formatCurrency(invoice_parseCurrency(document.getElementById('invoice-discount').value))}`; // CORREÇÃO AQUI
                const total = document.getElementById('invoice-total').textContent;

                let yPos = doc.lastAutoTable.finalY + 15;

                doc.setFontSize(12);
                doc.text(`Subtotal: ${subtotal}`, 150, yPos);
                yPos += 7;

                doc.text(`Taxas: ${tax}`, 150, yPos);
                yPos += 7;

                doc.text(`Descontos: ${discount}`, 150, yPos);
                yPos += 10;

                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text(`TOTAL: ${total}`, 150, yPos);

                yPos = doc.internal.pageSize.height - 20;
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                doc.text(" Francisco José - Setor Produtivo Florestal. Altamira-Pa.", 105, yPos, { align: 'center' });

                const fileName = `Orçamento_${invoiceNumber}_${clientName.replace(/[^a-z0-9]/gi, '_')}.pdf`;
                doc.save(fileName);
                showToast('PDF do orçamento gerado com sucesso!', 'success');
            } catch (error) {
                showToast("Erro ao gerar PDF do orçamento: " + error.message, 'danger');
            }
        }

        // --- Funções do Romaneio de Madeira Serrada (Prefixadas com 'romaneio_') ---
        let romaneio_romaneioItens = [];
        let romaneio_comprimentosAdicionadosParaForm = [];
        let romaneio_logoDataUrl = null;
        let romaneio_watermarkImageDataUrl = null;
        let romaneio_watermarkImageElement = null;
        let romaneio_itemToDeleteId = null;
        let romaneio_tempPdfBlob = null;

        const romaneio_tiposMadeira = ["BLOCO", "CABRINHO", "CAIBRO", "PEÇA", "PRANCHA", "RÉGUA", "RIPA", "RIPÃO", "TABUA"];

        function romaneio_initializeRomaneio() {
            // Elementos DOM do Romaneio
            const clienteInput = document.getElementById('romaneioCliente');
            const tipoInput = document.getElementById('romaneioTipo');
            const espessuraInput = document.getElementById('romaneioEspessura');
            const larguraInput = document.getElementById('romaneioLargura');
            const especieInput = document.getElementById('romaneioEspecie');
            const comprimentoInput = document.getElementById('romaneioComprimento');
            const pacoteInput = document.getElementById('romaneioPacote');
            const comentariosInput = document.getElementById('romaneioComentarios');
            const quantidadesContainer = document.getElementById('romaneioQuantidadesContainer');
            const adicionarBtn = document.getElementById('romaneioAdicionarBtn');
            const limparCamposBtn = document.getElementById('romaneioLimparCamposBtn');
            const limparTudoBtn = document.getElementById('romaneioLimparTudoBtn');

            const gerarPdfBtn = document.getElementById('romaneioGerarPdfBtn');
            const previewPdfBtn = document.getElementById('romaneioPreviewPdfBtn');

            const itensRomaneioTbody = document.getElementById('romaneioItensRomaneio');
            const tableHeaderRow = document.getElementById('romaneioTableHeaderRow');
            const resumoCliente = document.getElementById('romaneioResumoCliente');
            const resumoQuantidadeTotalGlobal = document.getElementById('romaneioResumoQuantidadeTotalGlobal');
            const totaisEspecie = document.getElementById('romaneioTotaisEspecie');
            const totalItensCount = document.getElementById('romaneioTotalItensCount');
            const totalItensBadge = document.getElementById('romaneioTotalItensBadge');

            const logoUpload = document.getElementById('romaneioLogoUpload');
            const logoContainer = document.getElementById('romaneioLogoContainer');
            const logoPreview = document.getElementById('romaneioLogoPreview');
            const clearLogoBtn = document.getElementById('romaneioClearLogoBtn');

            const watermarkUpload = document.getElementById('romaneioWatermarkUpload');
            const watermarkUploadLabel = document.getElementById('romaneioWatermarkUploadLabel');
            const removeWatermarkBtn = document.getElementById('romaneioRemoveWatermarkBtn');
            const watermarkPreviewContainer = document.getElementById('romaneioWatermarkPreviewContainer');
            const watermarkPreview = document.getElementById('romaneioWatermarkPreview');

            const editModal = document.getElementById('romaneioEditModal');
            const closeEditModal = document.getElementById('romaneioCloseEditModal');
            const cancelEditBtn = document.getElementById('romaneioCancelEditBtn');
            const salvarEdicaoBtn = document.getElementById('romaneioSalvarEdicaoBtn');
            const editIndex = document.getElementById('romaneioEditIndex');
            const editTipo = document.getElementById('romaneioEditTipo');
            const editEspessura = document.getElementById('romaneioEditEspessura');
            const editLargura = document.getElementById('romaneioEditLargura');
            const editEspecie = document.getElementById('romaneioEditEspecie');
            const editPacote = document.getElementById('romaneioEditPacote');
            const editComprimentoDisplay = document.getElementById('romaneioEditComprimentoDisplay');
            const editQuantidade = document.getElementById('romaneioEditQuantidade');

            const groupActionModal = document.getElementById('romaneioGroupActionModal');
            const groupActionModalTitle = document.getElementById('romaneioGroupActionModalTitle');
            const groupActionDetailsContainer = document.getElementById('romaneioGroupActionDetailsContainer');
            const closeGroupActionModalBtn = document.getElementById('romaneioCloseGroupActionModalBtn');
            const closeGroupActionModalFooterBtn = document.getElementById('romaneioCloseGroupActionModalFooterBtn');

            const confirmClearModal = document.getElementById('romaneioConfirmClearModal');
            const closeConfirmClear = document.getElementById('romaneioCloseConfirmClear');
            const cancelClearBtn = document.getElementById('romaneioCancelClearBtn');
            const confirmClearBtn = document.getElementById('romaneioConfirmClearBtn');

            const confirmDeleteModal = document.getElementById('romaneioConfirmDeleteModal');
            const closeConfirmDelete = document.getElementById('romaneioCloseConfirmDelete');
            const cancelDeleteBtn = document.getElementById('romaneioCancelDeleteBtn');
            const confirmDeleteBtn = document.getElementById('romaneioConfirmDeleteBtn');

            const pdfPreviewModal = document.getElementById('romaneioPdfPreviewModal');
            const closePdfPreviewModalBtn = document.getElementById('romaneioClosePdfPreviewModalBtn');
            const pdfPreviewIframe = document.getElementById('romaneioPdfPreviewIframe');
            const downloadPdfFromPreviewBtn = document.getElementById('romaneioDownloadPdfFromPreviewBtn');

            // Popula as opções do select para o modal de edição
            editTipo.innerHTML = ''; // Clear existing options
            romaneio_tiposMadeira.forEach(tipo => {
                const option = document.createElement('option');
                option.value = tipo;
                option.textContent = tipo;
                editTipo.appendChild(option.cloneNode(true));
            });

            // Adiciona listeners de evento
            document.getElementById('romaneioAddComprimentoBtn').onclick = romaneio_adicionarComprimentoParaForm;
            adicionarBtn.onclick = romaneio_adicionarItensAoRomaneio;
            limparCamposBtn.onclick = romaneio_limparApenasCamposDoItemAtual;
            limparTudoBtn.onclick = () => {
                confirmClearModal.classList.add('active'); // Use 'active' class for modal display
            };

            gerarPdfBtn.onclick = () => romaneio_gerarPdf('save');
            previewPdfBtn.onclick = romaneio_showPdfPreview;

            logoUpload.onchange = romaneio_handleLogoUpload;
            clearLogoBtn.onclick = romaneio_removerLogo;

            watermarkUpload.onchange = romaneio_handleWatermarkUpload;
            removeWatermarkBtn.onclick = romaneio_removerWatermark;

            clienteInput.oninput = romaneio_atualizarResumoCliente;

            closeEditModal.onclick = romaneio_fecharModalEdicao;
            cancelEditBtn.onclick = romaneio_fecharModalEdicao;
            salvarEdicaoBtn.onclick = romaneio_salvarEdicao;

            closeGroupActionModalBtn.onclick = romaneio_fecharModalAcaoGrupo;
            closeGroupActionModalFooterBtn.onclick = romaneio_fecharModalAcaoGrupo;

            closeConfirmClear.onclick = () => { confirmClearModal.classList.remove('active'); }; // Use 'active' class
            cancelClearBtn.onclick = () => { confirmClearModal.classList.remove('active'); }; // Use 'active' class
            confirmClearBtn.onclick = () => {
                romaneio_limparTudo();
                confirmClearModal.classList.remove('active'); // Use 'active' class
            };

            closeConfirmDelete.onclick = () => { confirmDeleteModal.classList.remove('active'); romaneio_itemToDeleteId = null; }; // Use 'active' class
            cancelDeleteBtn.onclick = () => { confirmDeleteModal.classList.remove('active'); romaneio_itemToDeleteId = null; }; // Use 'active' class
            confirmDeleteBtn.onclick = () => {
                if (romaneio_itemToDeleteId) {
                    romaneio_romaneioItens = romaneio_romaneioItens.filter(item => item.id !== romaneio_itemToDeleteId);
                    showToast('Item excluído com sucesso.', 'success');
                    romaneio_fecharModalAcaoGrupo();
                    romaneio_atualizarTabelaEInterface();
                    confirmDeleteModal.classList.remove('active'); // Use 'active' class
                    romaneio_itemToDeleteId = null;
                }
            };

            closePdfPreviewModalBtn.onclick = romaneio_closePdfPreviewModalFunction;
            downloadPdfFromPreviewBtn.onclick = () => {
                if (romaneio_tempPdfBlob) {
                    const clienteFileName = clienteInput.value.trim().replace(/\s+/g, '_') || 'Sem_Cliente';
                    const dateFileName = new Date().toISOString().slice(0, 10);
                    const fileName = `Romaneio_${clienteFileName}_${dateFileName}.pdf`;

                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(romaneio_tempPdfBlob);
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(a.href);
                    showToast("PDF baixado!", 'success');
                } else {
                    showToast("Nenhum PDF para baixar. Gere um primeiro.", 'warning');
                }
            };

            romaneio_loadSavedData();
            romaneio_atualizarTabelaEInterface();
        }

        function romaneio_formatarNumero(num, casas = 3) {
            if (typeof num !== 'number' || isNaN(num)) return '0,000';
            return num.toFixed(casas).replace('.', ',');
        }

        function romaneio_calculateM3(espessura, largura, comprimento, quantidade) {
            if(isNaN(espessura) || isNaN(largura) || isNaN(comprimento) || isNaN(quantidade)) return 0;
            return (espessura / 100) * (largura / 100) * comprimento * quantidade;
        }

        function romaneio_generateUniqueId() {
            return crypto.randomUUID();
        }

        function romaneio_saveToLocalStorage() {
            localStorage.setItem('romaneioItens', JSON.stringify(romaneio_romaneioItens));
            localStorage.setItem('romaneioClienteNome', document.getElementById('romaneioCliente').value);
            localStorage.setItem('romaneioComentarios', document.getElementById('romaneioComentarios').value);
            if (romaneio_logoDataUrl) localStorage.setItem('romaneioLogoDataUrl', romaneio_logoDataUrl);
            else localStorage.removeItem('romaneioLogoDataUrl');
            if (romaneio_watermarkImageDataUrl) localStorage.setItem('romaneioWatermarkImageDataUrl', romaneio_watermarkImageDataUrl);
            else localStorage.removeItem('romaneioWatermarkImageDataUrl');
        }

        function romaneio_loadSavedData() {
            const savedItems = localStorage.getItem('romaneioItens');
            if (savedItems) {
                romaneio_romaneioItens = JSON.parse(savedItems);
            }
            document.getElementById('romaneioCliente').value = localStorage.getItem('romaneioClienteNome') || '';
            document.getElementById('romaneioComentarios').value = localStorage.getItem('romaneioComentarios') || '';

            const savedLogo = localStorage.getItem('romaneioLogoDataUrl');
            if (savedLogo) {
                romaneio_logoDataUrl = savedLogo;
                document.getElementById('romaneioLogoPreview').src = romaneio_logoDataUrl;
                document.getElementById('romaneioLogoContainer').classList.remove('hidden');
                document.getElementById('romaneioClearLogoBtn').classList.remove('hidden');
            }

            const savedWatermark = localStorage.getItem('romaneioWatermarkImageDataUrl');
            if (savedWatermark) {
                romaneio_watermarkImageDataUrl = savedWatermark;
                romaneio_watermarkImageElement = new Image();
                romaneio_watermarkImageElement.onload = () => {
                    document.getElementById('romaneioWatermarkPreview').src = romaneio_watermarkImageDataUrl;
                    document.getElementById('romaneioWatermarkPreviewContainer').classList.remove('hidden');
                    document.getElementById('romaneioRemoveWatermarkBtn').classList.remove('hidden');
                    document.getElementById('romaneioWatermarkUploadLabel').classList.add('hidden');
                };
                romaneio_watermarkImageElement.onerror = () => {
                    console.error("Erro ao carregar marca d'água salva.");
                    romaneio_removerWatermark();
                };
                romaneio_watermarkImageElement.src = romaneio_watermarkImageDataUrl;
            }
        }

        function romaneio_adicionarComprimentoParaForm() {
            const comprimentoInput = document.getElementById('romaneioComprimento');
            const comprimentoValue = parseFloat(comprimentoInput.value);
            if (isNaN(comprimentoValue) || comprimentoValue <= 0) {
                showToast('Informe um comprimento válido e maior que zero.', 'danger'); return;
            }
            if (romaneio_comprimentosAdicionadosParaForm.includes(comprimentoValue)) {
                showToast('Este comprimento já foi adicionado para este item.', 'warning'); return;
            }
            romaneio_comprimentosAdicionadosParaForm.push(comprimentoValue);
            romaneio_comprimentosAdicionadosParaForm.sort((a, b) => a - b);
            romaneio_renderizarCamposQuantidadeParaForm();
            comprimentoInput.value = '';
            comprimentoInput.focus();
            showToast('Comprimento adicionado com sucesso!', 'success');
        }

        function romaneio_renderizarCamposQuantidadeParaForm() {
            const quantidadesContainer = document.getElementById('romaneioQuantidadesContainer');
            if (romaneio_comprimentosAdicionadosParaForm.length === 0) {
                quantidadesContainer.innerHTML = '<p class="text-gray-400 dark:text-gray-500 text-sm self-center animate-pulse-slow">Adicione comprimentos para inserir quantidades.</p>'; return;
            }
            quantidadesContainer.innerHTML = '';
            romaneio_comprimentosAdicionadosParaForm.forEach(comp => {
                const div = document.createElement('div');
                div.className = 'flex flex-col items-start animate-fade-in';
                div.innerHTML = `
                    <label class="text-xs text-gray-600 dark:text-gray-300 mb-1">${romaneio_formatarNumero(comp,1)}m</label>
                    <div class="flex items-center gap-2">
                        <input type="number" class="quantidade-input input px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 w-24 modal-input" placeholder="Qtd" data-comprimento="${comp}">
                        <button type="button" class="remove-comprimento-btn text-danger-500 hover:text-danger-700" data-comprimento="${comp}">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>`;
                quantidadesContainer.appendChild(div);
            });
            document.querySelectorAll('#romaneioQuantidadesContainer .remove-comprimento-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const compToRemove = parseFloat(this.getAttribute('data-comprimento'));
                    romaneio_comprimentosAdicionadosParaForm = romaneio_comprimentosAdicionadosParaForm.filter(c => c !== compToRemove);
                    romaneio_renderizarCamposQuantidadeParaForm();
                    showToast('Comprimento removido.', 'info');
                });
            });
        }

        function romaneio_adicionarItensAoRomaneio() {
            const tipoInput = document.getElementById('romaneioTipo');
            const espessuraInput = document.getElementById('romaneioEspessura');
            const larguraInput = document.getElementById('romaneioLargura');
            const especieInput = document.getElementById('romaneioEspecie');
            const pacoteInput = document.getElementById('romaneioPacote');
            const comentariosInput = document.getElementById('romaneioComentarios');
            const quantidadesContainer = document.getElementById('romaneioQuantidadesContainer');

            const tipo = tipoInput.value.trim();
            const espessura = parseFloat(espessuraInput.value);
            const largura = parseFloat(larguraInput.value);
            const especie = especieInput.value.trim().toUpperCase();
            const pacote = pacoteInput.value.trim().toUpperCase() || 'N/A';
            const comentariosGlobais = comentariosInput.value.trim();

            if (!especie) { showToast('Informe a espécie.', 'danger'); especieInput.focus(); return; }
            if (!tipo) { showToast('Selecione o tipo.', 'danger'); tipoInput.focus(); return; }
            if (isNaN(espessura) || espessura <= 0) { showToast('Espessura inválida.', 'danger'); espessuraInput.focus(); return; }
            if (isNaN(largura) || largura <= 0) { showToast('Largura inválida.', 'danger'); larguraInput.focus(); return; }
            if (romaneio_comprimentosAdicionadosParaForm.length === 0) { showToast('Adicione pelo menos um comprimento e sua quantidade.', 'danger'); return; }

            const inputsQuantidade = quantidadesContainer.querySelectorAll('.quantidade-input');
            let itensAdicionadosComSucesso = 0;
            let peloMenosUmaQuantidadeInformada = false;

            inputsQuantidade.forEach(input => {
                const quantidadeVal = parseInt(input.value);
                if (!isNaN(quantidadeVal) && quantidadeVal > 0) {
                    peloMenosUmaQuantidadeInformada = true;
                    const comprimento = parseFloat(input.getAttribute('data-comprimento'));
                    const m3 = romaneio_calculateM3(espessura, largura, comprimento, quantidadeVal);
                    romaneio_romaneioItens.push({
                        id: romaneio_generateUniqueId(), tipo, espessura, largura, especie, pacote,
                        comprimento, quantidade: quantidadeVal, m3, comentarios: comentariosGlobais
                    });
                    itensAdicionadosComSucesso++;
                }
            });

            if (!peloMenosUmaQuantidadeInformada && romaneio_comprimentosAdicionadosParaForm.length > 0) {
                showToast('Informe a quantidade para pelo menos um dos comprimentos adicionados.', 'danger'); return;
            }
            if (itensAdicionadosComSucesso === 0) { return; }

            inputsQuantidade.forEach(input => { input.value = ''; });
            especieInput.focus();
            showToast(`${itensAdicionadosComSucesso} item(s) adicionado(s) ao romaneio!`, 'success');
            romaneio_atualizarTabelaEInterface();
            romaneio_saveToLocalStorage();
        }

        function romaneio_limparApenasCamposDoItemAtual() {
            document.getElementById('romaneioEspecie').value = '';
            document.getElementById('romaneioTipo').value = '';
            document.getElementById('romaneioEspessura').value = '';
            document.getElementById('romaneioLargura').value = '';
            document.getElementById('romaneioPacote').value = '';
            document.getElementById('romaneioComprimento').value = '';
            romaneio_comprimentosAdicionadosParaForm = [];
            romaneio_renderizarCamposQuantidadeParaForm();
            document.getElementById('romaneioEspecie').focus();
            showToast('Campos do item atual limpos.', 'info');
        }

        function romaneio_limparTudo() {
            romaneio_romaneioItens = [];
            romaneio_comprimentosAdicionadosParaForm = [];
            romaneio_logoDataUrl = null;
            romaneio_watermarkImageDataUrl = null;
            romaneio_watermarkImageElement = null; // Ensure the Image object is also reset

            document.getElementById('romaneioLogoContainer').classList.add('hidden');
            document.getElementById('romaneioClearLogoBtn').classList.add('hidden');
            document.getElementById('romaneioLogoPreview').src = '';

            document.getElementById('romaneioWatermarkPreviewContainer').classList.add('hidden');
            document.getElementById('romaneioRemoveWatermarkBtn').classList.add('hidden');
            document.getElementById('romaneioWatermarkPreview').src = '';
            document.getElementById('romaneioWatermarkUploadLabel').classList.remove('hidden');

            romaneio_limparApenasCamposDoItemAtual();
            document.getElementById('romaneioCliente').value = '';
            document.getElementById('romaneioComentarios').value = '';

            romaneio_saveToLocalStorage();
            romaneio_atualizarTabelaEInterface();
            showToast('Todos os dados do romaneio foram limpos.', 'success');
        }

        function romaneio_getGroupedRomaneioItems() {
            const grouped = {};
            romaneio_romaneioItens.forEach((item) => {
                const groupKey = `${item.especie}-${item.tipo}-${item.espessura}x${item.largura}-${item.pacote}`;
                if (!grouped[groupKey]) {
                    grouped[groupKey] = {
                        especie: item.especie, tipo: item.tipo, bitola: `${item.espessura}x${item.largura}`,
                        pacote: item.pacote, comprimentosMap: {}, totalPecas: 0, ml: 0, m3Agrupado: 0, subItensIds: []
                    };
                }
                const group = grouped[groupKey];
                if (!group.comprimentosMap[item.comprimento]) {
                    group.comprimentosMap[item.comprimento] = { quantidade: 0, ids: [] };
                }
                group.comprimentosMap[item.comprimento].quantidade += item.quantidade;
                group.comprimentosMap[item.comprimento].ids.push(item.id);
                group.totalPecas += item.quantidade;
                group.ml += item.comprimento * item.quantidade;
                group.m3Agrupado += item.m3;
                group.subItensIds.push(item.id);
            });
            return Object.values(grouped).sort((a,b) => {
                if (a.especie < b.especie) return -1; if (a.especie > b.especie) return 1;
                if (a.tipo < b.tipo) return -1; if (a.tipo > b.tipo) return 1; return 0;
            });
        }

        function romaneio_getAllUniqueLengths(groupedItems) {
            const lengths = new Set();
            groupedItems.forEach(group => {
                Object.keys(group.comprimentosMap).forEach(len => lengths.add(parseFloat(len)));
            });
            return Array.from(lengths).sort((a, b) => a - b);
        }

        function romaneio_atualizarTabelaEInterface() {
            const romaneioItensRomaneioTbody = document.getElementById('romaneioItensRomaneio');
            const romaneioTableHeaderRow = document.getElementById('romaneioTableHeaderRow');
            const romaneioTotalItensCount = document.getElementById('romaneioTotalItensCount');
            const romaneioTotalItensBadge = document.getElementById('romaneioTotalItensBadge');

            const groupedItems = romaneio_getGroupedRomaneioItems();
            const uniqueLengths = romaneio_getAllUniqueLengths(groupedItems);

            romaneioTableHeaderRow.innerHTML = `
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Espécie</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Tipo</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Bitola</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Pacote</th>
                ${uniqueLengths.map(len => `<th class="px-3 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">${romaneio_formatarNumero(len,1)}m</th>`).join('')}
                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">T.Peças</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">ML</th>
                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">M³</th>
                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Ações</th>`;

            romaneioItensRomaneioTbody.innerHTML = '';
            if (groupedItems.length === 0) {
                romaneioItensRomaneioTbody.innerHTML = `<tr><td colspan="${8 + uniqueLengths.length}" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">Nenhum item no romaneio.</td></tr>`;
            } else {
                groupedItems.forEach((group, groupIndex) => {
                    const tr = document.createElement('tr');
                    tr.className = groupIndex % 2 === 0 ? 'bg-white dark:bg-gray-800' : 'bg-gray-50 dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600';
                    let rowHtml = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-800 dark:text-gray-100">${group.especie}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 dark:text-gray-100">${group.tipo}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 dark:text-gray-100">${group.bitola}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-800 dark:text-gray-100">${group.pacote}</td>`;
                    uniqueLengths.forEach(len => {
                        const qtdInfo = group.comprimentosMap[len];
                        rowHtml += `<td class="px-3 py-4 whitespace-nowrap text-sm text-center text-gray-800 dark:text-gray-100">${qtdInfo ? qtdInfo.quantidade : '-'}</td>`;
                    });
                    rowHtml += `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-center font-semibold text-gray-800 dark:text-gray-100">${group.totalPecas}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-gray-800 dark:text-gray-100">${romaneio_formatarNumero(group.ml, 2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-right font-semibold text-gray-800 dark:text-gray-100">${romaneio_formatarNumero(group.m3Agrupado)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-gray-800 dark:text-gray-100">
                            <button class="text-primary-600 hover:text-primary-800 romaneio-group-action-btn p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700" data-group-key="${group.especie}-${group.tipo}-${group.bitola}-${group.pacote}"><i class="fas fa-ellipsis-v"></i></button>
                        </td>`;
                    tr.innerHTML = rowHtml;
                    romaneioItensRomaneioTbody.appendChild(tr);
                });
            }

            document.querySelectorAll('#romaneioItensRomaneio .romaneio-group-action-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const groupKey = e.currentTarget.getAttribute('data-group-key');
                    const currentGroupedItems = romaneio_getGroupedRomaneioItems();
                    const selectedGroup = currentGroupedItems.find(g => `${g.especie}-${g.tipo}-${g.bitola}-${g.pacote}` === groupKey);
                    if (selectedGroup) romaneio_abrirModalAcaoGrupo(selectedGroup);
                });
            });

            romaneioTotalItensCount.textContent = romaneio_romaneioItens.length;
            romaneioTotalItensBadge.classList.toggle('badge-success', romaneio_romaneioItens.length > 0);
            romaneioTotalItensBadge.classList.toggle('badge-primary', romaneio_romaneioItens.length === 0);
            romaneio_atualizarResumo();
            romaneio_saveToLocalStorage();
        }

        function romaneio_atualizarResumoCliente() {
            const clienteInput = document.getElementById('romaneioCliente');
            const resumoCliente = document.getElementById('romaneioResumoCliente');
            const cliente = clienteInput.value.trim();
            resumoCliente.innerHTML = cliente ? `<div class="flex items-center gap-2"><i class="fas fa-user-circle text-primary-500"></i><span class="font-medium">${cliente}</span></div>` : '<span class="text-gray-400 dark:text-gray-500">Nenhum cliente informado</span>';
            romaneio_saveToLocalStorage();
        }

        function romaneio_atualizarResumo() {
            romaneio_atualizarResumoCliente();
            const romaneioResumoQuantidadeTotalGlobal = document.getElementById('romaneioResumoQuantidadeTotalGlobal');
            const romaneioTotaisEspecie = document.getElementById('romaneioTotaisEspecie');

            const groupedItems = romaneio_getGroupedRomaneioItems();
            let totalPecasGlobalCalc = 0, totalMLGlobalCalc = 0, totalM3GlobalCalc = 0;
            groupedItems.forEach(group => { totalPecasGlobalCalc += group.totalPecas; totalMLGlobalCalc += group.ml; totalM3GlobalCalc += group.m3Agrupado; });

            romaneioResumoQuantidadeTotalGlobal.innerHTML = `
                <span class="block text-3xl font-bold gradient-text">${totalPecasGlobalCalc}</span>
                <span class="text-sm text-gray-500 dark:text-gray-400">peças no total</span>
                <div class="mt-2 pt-2 border-t border-gray-200 dark:border-gray-700 text-xs">
                    <div class="flex justify-between"><span>Total ML:</span><strong class="text-gray-800 dark:text-gray-200">${romaneio_formatarNumero(totalMLGlobalCalc, 2)}</strong></div>
                    <div class="flex justify-between"><span>Total M³:</span><strong class="text-gray-800 dark:text-gray-200">${romaneio_formatarNumero(totalM3GlobalCalc)}</strong></div>
                </div>`;

            if (groupedItems.length === 0) {
                romaneioTotaisEspecie.innerHTML = `<div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border border-gray-200 dark:border-gray-600 text-center"><span class="text-gray-400 dark:text-gray-500">Nenhum item</span></div>`; return;
            }
            romaneioTotaisEspecie.innerHTML = '';
            groupedItems.forEach(group => {
                const div = document.createElement('div');
                div.className = 'bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border border-gray-200 dark:border-gray-600';
                let comprimentosHtml = '<ul class="list-disc list-inside pl-2 text-xs mt-2 space-y-1">';
                Object.entries(group.comprimentosMap).sort(([lenA], [lenB]) => parseFloat(lenA) - parseFloat(lenB))
                    .forEach(([len, data]) => { comprimentosHtml += `<li class="flex justify-between"><span>${romaneio_formatarNumero(parseFloat(len),1)}m:</span><span class="font-medium">${data.quantidade} pçs</span></li>`; });
                comprimentosHtml += '</ul>';
                div.innerHTML = `
                    <div class="flex justify-between items-start"><div><h4 class="font-medium text-gray-800 dark:text-gray-200">${group.especie}</h4><p class="text-xs text-gray-500 dark:text-gray-400">${group.tipo} / ${group.bitola}</p></div>
                    ${group.pacote !== 'N/A' ? `<span class="text-xs bg-secondary-100 dark:bg-gray-700 text-secondary-800 dark:text-gray-300 px-2 py-1 rounded-full">Pacote: ${group.pacote}</span>` : ''}</div>
                    ${comprimentosHtml}
                    <div class="mt-3 pt-2 border-t border-gray-200 dark:border-gray-700 text-xs space-y-1">
                        <div class="flex justify-between"><span>Tot. Peças:</span><strong class="text-gray-800 dark:text-gray-200">${group.totalPecas}</strong></div>
                        <div class="flex justify-between"><span>ML:</span><strong class="text-gray-800 dark:text-gray-200">${romaneio_formatarNumero(group.ml,2)}</strong></div>
                        <div class="flex justify-between"><span>M³:</span><strong class="text-gray-800 dark:text-gray-200">${romaneio_formatarNumero(group.m3Agrupado)}</strong></div>
                    </div>`;
                romaneioTotaisEspecie.appendChild(div);
            });
        }

        function romaneio_handleLogoUpload(e) {
            const logoUpload = document.getElementById('romaneioLogoUpload');
            const logoContainer = document.getElementById('romaneioLogoContainer');
            const logoPreview = document.getElementById('romaneioLogoPreview');
            const clearLogoBtn = document.getElementById('romaneioClearLogoBtn');

            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(event) {
                romaneio_logoDataUrl = event.target.result; logoPreview.src = romaneio_logoDataUrl;
                logoContainer.classList.remove('hidden'); clearLogoBtn.classList.remove('hidden');
                showToast('Logo carregada!', 'success');
                romaneio_saveToLocalStorage();
            };
            reader.readAsDataURL(file);
        }
        function romaneio_removerLogo() {
            const logoUpload = document.getElementById('romaneioLogoUpload');
            const logoContainer = document.getElementById('romaneioLogoContainer');
            const logoPreview = document.getElementById('romaneioLogoPreview');
            const clearLogoBtn = document.getElementById('romaneioClearLogoBtn');

            romaneio_logoDataUrl = null; logoPreview.src = ''; logoContainer.classList.add('hidden');
            clearLogoBtn.classList.add('hidden'); logoUpload.value = '';
            romaneio_saveToLocalStorage();
            showToast('Logo removida!', 'info');
        }

        function romaneio_handleWatermarkUpload(e) {
            const watermarkUploadLabel = document.getElementById('romaneioWatermarkUploadLabel');
            const removeWatermarkBtn = document.getElementById('romaneioRemoveWatermarkBtn');
            const watermarkPreviewContainer = document.getElementById('romaneioWatermarkPreviewContainer');
            const watermarkPreview = document.getElementById('romaneioWatermarkPreview');

            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(event) {
                romaneio_watermarkImageDataUrl = event.target.result;
                romaneio_watermarkImageElement = new Image();
                romaneio_watermarkImageElement.onload = () => {
                    watermarkPreview.src = romaneio_watermarkImageDataUrl;
                    watermarkPreviewContainer.classList.remove('hidden');
                    removeWatermarkBtn.classList.remove('hidden');
                    watermarkUploadLabel.classList.add('hidden');
                    showToast('Marca d\'água carregada!', 'success');
                    romaneio_saveToLocalStorage();
                };
                romaneio_watermarkImageElement.onerror = () => {
                    showToast('Erro ao carregar imagem da marca d\'água.', 'danger');
                    romaneio_removerWatermark();
                };
                romaneio_watermarkImageElement.src = romaneio_watermarkImageDataUrl;
            };
            reader.readAsDataURL(file);
        }
        function romaneio_removerWatermark() {
            const watermarkUpload = document.getElementById('romaneioWatermarkUpload');
            const watermarkUploadLabel = document.getElementById('romaneioWatermarkUploadLabel');
            const removeWatermarkBtn = document.getElementById('romaneioRemoveWatermarkBtn');
            const watermarkPreviewContainer = document.getElementById('romaneioWatermarkPreviewContainer');
            const watermarkPreview = document.getElementById('romaneioWatermarkPreview');

            romaneio_watermarkImageDataUrl = null; romaneio_watermarkImageElement = null;
            watermarkPreview.src = ''; watermarkPreviewContainer.classList.add('hidden');
            removeWatermarkBtn.classList.add('hidden'); watermarkUpload.value = '';
            watermarkUploadLabel.classList.remove('hidden');
            romaneio_saveToLocalStorage();
            showToast('Marca d\'água removida!', 'info');
        }

        function romaneio_abrirModalAcaoGrupo(group) {
            const groupActionModal = document.getElementById('romaneioGroupActionModal');
            const groupActionModalTitle = document.getElementById('romaneioGroupActionModalTitle');
            const groupActionDetailsContainer = document.getElementById('romaneioGroupActionDetailsContainer');

            groupActionModalTitle.textContent = `Detalhes: ${group.especie} / ${group.tipo} / ${group.bitola} (Pacote: ${group.pacote})`;
            groupActionDetailsContainer.innerHTML = '';
            const subItensDoGrupo = romaneio_romaneioItens.filter(item => group.subItensIds.includes(item.id));
            subItensDoGrupo.sort((a,b) => a.comprimento - b.comprimento).forEach(subItem => {
                const detailDiv = document.createElement('div');
                detailDiv.className = 'flex justify-between items-center p-3 border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg';
                detailDiv.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">${romaneio_formatarNumero(subItem.comprimento,1)}m</span>
                        <span class="text-sm text-gray-500 dark:text-gray-400">${subItem.quantidade} pçs</span>
                        <span class="text-xs bg-primary-100 dark:bg-primary-900 text-primary-800 dark:text-primary-300 px-2 py-1 rounded-full">M³: ${romaneio_formatarNumero(subItem.m3)}</span>
                    </div>
                    <div class="flex gap-2">
                        <button class="romaneio-group-item-edit-btn text-primary-600 hover:text-primary-800 text-sm py-1 px-3 rounded-md bg-primary-50 hover:bg-primary-100 dark:bg-primary-800 dark:hover:bg-primary-700 dark:text-primary-200" data-item-id="${subItem.id}"><i class="fas fa-edit mr-1"></i> Editar</button>
                        <button class="romaneio-group-item-delete-btn text-danger-600 hover:text-danger-800 text-sm py-1 px-3 rounded-md bg-danger-50 hover:bg-danger-100 dark:bg-danger-800 dark:hover:bg-danger-700 dark:text-danger-200" data-item-id="${subItem.id}"><i class="fas fa-trash mr-1"></i> Excluir</button>
                    </div>`;
                groupActionDetailsContainer.appendChild(detailDiv);
            });
            groupActionDetailsContainer.querySelectorAll('.romaneio-group-item-edit-btn').forEach(btn => btn.addEventListener('click', (e) => romaneio_abrirModalEdicao(e.currentTarget.getAttribute('data-item-id'))));
            groupActionDetailsContainer.querySelectorAll('.romaneio-group-item-delete-btn').forEach(btn => btn.addEventListener('click', (e) => romaneio_confirmarExclusaoItem(e.currentTarget.getAttribute('data-item-id'))));

            groupActionModal.classList.add('active'); // Use 'active' class
            groupActionModal.classList.toggle('dark', htmlElement.classList.contains('dark'));
        }

        function romaneio_confirmarExclusaoItem(itemId) {
            const confirmDeleteModal = document.getElementById('romaneioConfirmDeleteModal');
            romaneio_itemToDeleteId = itemId;
            confirmDeleteModal.classList.add('active'); // Use 'active' class
            confirmDeleteModal.classList.toggle('dark', htmlElement.classList.contains('dark'));
        }

        function romaneio_fecharModalAcaoGrupo() {
            document.getElementById('romaneioGroupActionModal').classList.remove('active'); // Use 'active' class
        }

        function romaneio_abrirModalEdicao(itemId) {
            const editModal = document.getElementById('romaneioEditModal');
            const editIndex = document.getElementById('romaneioEditIndex');
            const editTipo = document.getElementById('romaneioEditTipo');
            const editEspessura = document.getElementById('romaneioEditEspessura');
            const editLargura = document.getElementById('romaneioEditLargura');
            const editEspecie = document.getElementById('romaneioEditEspecie');
            const editPacote = document.getElementById('romaneioEditPacote');
            const editComprimentoDisplay = document.getElementById('romaneioEditComprimentoDisplay');
            const editQuantidade = document.getElementById('romaneioEditQuantidade');

            const itemIndex = romaneio_romaneioItens.findIndex(item => item.id === itemId);
            if (itemIndex === -1) { showToast("Item não encontrado.", 'danger'); return; }
            const item = romaneio_romaneioItens[itemIndex];
            editIndex.value = itemIndex;
            editTipo.value = item.tipo; editEspessura.value = item.espessura; editLargura.value = item.largura;
            editEspecie.value = item.especie; editPacote.value = item.pacote === 'N/A' ? '' : item.pacote;
            editComprimentoDisplay.textContent = `${romaneio_formatarNumero(item.comprimento,1)}m`;
            editQuantidade.value = item.quantidade;
            romaneio_fecharModalAcaoGrupo();
            editModal.classList.add('active'); // Use 'active' class
            editModal.classList.toggle('dark', htmlElement.classList.contains('dark'));
        }

        function romaneio_fecharModalEdicao() {
            document.getElementById('romaneioEditModal').classList.remove('active'); // Use 'active' class
        }

        function romaneio_salvarEdicao() {
            const editIndex = document.getElementById('romaneioEditIndex');
            const editTipo = document.getElementById('romaneioEditTipo');
            const editEspessura = document.getElementById('romaneioEditEspessura');
            const editLargura = document.getElementById('romaneioEditLargura');
            const editEspecie = document.getElementById('romaneioEditEspecie');
            const editPacote = document.getElementById('romaneioEditPacote');
            const editQuantidade = document.getElementById('romaneioEditQuantidade');

            const index = parseInt(editIndex.value);
            const itemOriginal = romaneio_romaneioItens[index];

            if (isNaN(index) || index < 0 || index >= romaneio_romaneioItens.length) {
                showToast("Erro ao salvar edição: índice inválido.", 'danger');
                return;
            }

            const tipo = editTipo.value.trim();
            const espessura = parseFloat(editEspessura.value);
            const largura = parseFloat(editLargura.value);
            const especie = editEspecie.value.trim().toUpperCase();
            const pacote = editPacote.value.trim().toUpperCase() || 'N/A';
            const quantidade = parseInt(editQuantidade.value);
            const comprimento = itemOriginal.comprimento;

            if (!tipo || isNaN(espessura) || espessura <= 0 || isNaN(largura) || largura <= 0 || !especie || isNaN(quantidade) || quantidade <= 0) {
                showToast("Por favor, preencha todos os campos obrigatórios no modal de edição com valores válidos.", 'warning');
                return;
            }

            const m3 = romaneio_calculateM3(espessura, largura, comprimento, quantidade);

            romaneio_romaneioItens[index] = {
                id: itemOriginal.id,
                tipo,
                espessura,
                largura,
                especie,
                pacote,
                comprimento,
                quantidade,
                m3,
                comentarios: itemOriginal.comentarios
            };

            romaneio_fecharModalEdicao();
            romaneio_atualizarTabelaEInterface();
            showToast("Item atualizado com sucesso!", 'success');
            romaneio_saveToLocalStorage();
        }

        async function romaneio_processWatermarkForPdf(imageElement) {
            if (!imageElement) return null;
            return new Promise((resolve) => {
                const tempCanvas = document.createElement('canvas');
                const ctx = tempCanvas.getContext('2d');

                const aspectRatio = imageElement.width / imageElement.height;
                tempCanvas.width = imageElement.width > 500 ? 500 : imageElement.width;
                tempCanvas.height = tempCanvas.width / aspectRatio;

                ctx.drawImage(imageElement, 0, 0, tempCanvas.width, tempCanvas.height);

                const imageData = ctx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
                const data = imageData.data;
                for (let i = 0; i < data.length; i += 4) {
                    const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                    data[i]     = avg;
                    data[i + 1] = avg;
                    data[i + 2] = avg;
                    data[i + 3] = data[i + 3] * 0.1;
                }
                ctx.putImageData(imageData, 0, 0);
                resolve(tempCanvas.toDataURL('image/png'));
            });
        }

        async function romaneio_gerarPdfInternal() {
            if (romaneio_romaneioItens.length === 0) {
                showToast('Adicione itens ao romaneio.', 'danger'); return null;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape', unit: 'mm', format: 'a4' });
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const margin = 10;
            let yPos = margin;

            doc.setFontSize(18); doc.setFont('helvetica', 'bold'); doc.setTextColor(15, 23, 42);
            doc.text('ROMANEIO DE MADEIRA SERRADA', pageWidth / 2, yPos + 5, { align: 'center' });
            yPos += 10;

            if (romaneio_logoDataUrl) {
                try {
                    const imgProps = doc.getImageProperties(romaneio_logoDataUrl);
                    const logoWidth = 25; const logoHeight = (imgProps.height * logoWidth) / imgProps.width;
                    doc.addImage(romaneio_logoDataUrl, imgProps.format || 'PNG', pageWidth - margin - logoWidth, margin -5, logoWidth, logoHeight);
                } catch (e) { console.warn("Erro ao adicionar logo ao PDF:", e); }
            }

            doc.setFontSize(10); doc.setFont('helvetica', 'normal');
            doc.text(`Cliente: ${document.getElementById('romaneioCliente').value.trim() || 'Não Informado'}`, margin, yPos + 5);
            doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, pageWidth - margin - 60, yPos + 5);
            yPos += 10;

            const groupedItems = romaneio_getGroupedRomaneioItems();
            const uniqueLengths = romaneio_getAllUniqueLengths(groupedItems);
            const tableHeadersBase = ['Espécie', 'Tipo', 'Bitola', 'Pacote'];
            const lengthHeaders = uniqueLengths.map(len => `${romaneio_formatarNumero(len,1)}m`);
            const tableHeadersEnd = ['T.Peças', 'ML', 'M³'];
            const head = [tableHeadersBase.concat(lengthHeaders).concat(tableHeadersEnd)];
            const body = [];
            groupedItems.forEach(group => {
                const rowBase = [group.especie, group.tipo, group.bitola, group.pacote];
                const lengthQuantities = uniqueLengths.map(len => group.comprimentosMap[len] ? group.comprimentosMap[len].quantidade.toString() : '-');
                const rowEnd = [group.totalPecas.toString(), romaneio_formatarNumero(group.ml,2), romaneio_formatarNumero(group.m3Agrupado)];
                body.push(rowBase.concat(lengthQuantities).concat(rowEnd));
            });

            let totalPecasGlobalPDF = 0, totalMLGlobalPDF = 0, totalM3GlobalPDF = 0;
            groupedItems.forEach(g => { totalPecasGlobalPDF += g.totalPecas; totalMLGlobalPDF += g.ml; totalM3GlobalPDF += g.m3Agrupado; });
            const footerRow = new Array(head[0].length).fill('');
            footerRow[0] = 'TOTAIS GLOBAIS:';
            footerRow[head[0].length - 3] = totalPecasGlobalPDF.toString();
            footerRow[head[0].length - 2] = romaneio_formatarNumero(totalMLGlobalPDF, 2);
            footerRow[head[0].length - 1] = romaneio_formatarNumero(totalM3GlobalPDF);
            if (groupedItems.length > 0) body.push(footerRow);

            const processedWatermarkDataUrlForPdf = romaneio_watermarkImageElement ? await romaneio_processWatermarkForPdf(romaneio_watermarkImageElement) : null;

            doc.autoTable({
                startY: yPos, head: head, body: body, theme: 'striped',
                styles: { fontSize: 7, cellPadding: 1, overflow: 'linebreak', textColor: [15, 23, 42] },
                headStyles: { fillColor: [226, 232, 240], textColor: [15, 23, 42], fontStyle: 'bold', halign: 'center' },
                columnStyles: {
                    0: { cellWidth: 'auto', halign: 'left' }, 1: { cellWidth: 'auto', halign: 'left' },
                    2: { cellWidth: 18, halign: 'center' }, 3: { cellWidth: 'auto', halign: 'left' },
                    [head[0].length -1]: { halign: 'right' }, [head[0].length -2]: { halign: 'right' },
                    [head[0].length -3]: { halign: 'center' },
                },
                didParseCell: function (data) {
                    if (body.length > 0 && data.row.index === body.length - 1 && groupedItems.length > 0) {
                        data.cell.styles.fontStyle = 'bold'; data.cell.styles.fillColor = [241, 245, 249];
                        if (data.column.index >= tableHeadersBase.length && data.column.index < tableHeadersBase.length + uniqueLengths.length) {
                            data.cell.styles.halign = 'center';
                        }
                    }
                    if (data.column.index >= tableHeadersBase.length && data.column.index < tableHeadersBase.length + uniqueLengths.length) {
                        if (data.cell.raw !== '-' && !(body.length > 0 && data.row.index === body.length - 1)) { data.cell.styles.halign = 'center'; }
                    }
                },
                didDrawPage: function(data) {
                    if (processedWatermarkDataUrlForPdf) {
                        const imgWatermarkProps = doc.getImageProperties(processedWatermarkDataUrlForPdf);
                        const watermarkTargetWidthMm = 120;
                        const watermarkTargetHeightMm = (imgWatermarkProps.height * watermarkTargetWidthMm) / imgWatermarkProps.width;
                        const x_w = (pageWidth - watermarkTargetWidthMm) / 2;
                        const y_w = (pageHeight - watermarkTargetHeightMm) / 2;
                        doc.addImage(processedWatermarkDataUrlForPdf, 'PNG', x_w, y_w, watermarkTargetWidthMm, watermarkTargetHeightMm, undefined, 'FAST');
                    }
                    doc.setFontSize(7); doc.setFont('helvetica', 'italic'); doc.setTextColor(100, 116, 139);
                    doc.text(`Página ${data.pageNumber} de ${doc.internal.getNumberOfPages()}`, pageWidth - margin - 25, pageHeight - margin + 7);
                    doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, margin, pageHeight - margin + 7);
                }
            });

            yPos = doc.autoTable.previous.finalY + 7;
            if (yPos > pageHeight - 25) {
                doc.addPage();
                yPos = margin;
                 if (processedWatermarkDataUrlForPdf) {
                    const imgWatermarkProps = doc.getImageProperties(processedWatermarkDataUrlForPdf);
                    const watermarkTargetWidthMm = 180;
                    const watermarkTargetHeightMm = (imgWatermarkProps.height * watermarkTargetWidthMm) / imgWatermarkProps.width;
                    const x_w = (pageWidth - watermarkTargetWidthMm) / 2;
                    const y_w = (pageHeight - watermarkTargetHeightMm) / 2;
                    doc.addImage(processedWatermarkDataUrlForPdf, 'PNG', x_w, y_w, watermarkTargetWidthMm, watermarkTargetHeightMm, undefined, 'FAST');
                }
            }

            if (document.getElementById('romaneioComentarios').value.trim()) {
                doc.setFontSize(8); doc.setFont('helvetica', 'italic'); doc.setTextColor(71, 85, 105);
                doc.text('Comentários:', margin, yPos); yPos += 4;
                const splitComments = doc.splitTextToSize(document.getElementById('romaneioComentarios').value.trim(), pageWidth - (2 * margin));
                doc.text(splitComments, margin, yPos);
            }

            return doc.output('blob');
        }

        async function romaneio_gerarPdf(action = 'save') {
            const previewPdfBtn = document.getElementById('romaneioPreviewPdfBtn');
            const gerarPdfBtn = document.getElementById('romaneioGerarPdfBtn');
            const pdfPreviewIframe = document.getElementById('romaneioPdfPreviewIframe');
            const pdfPreviewModal = document.getElementById('romaneioPdfPreviewModal');

            const targetButton = action === 'preview' ? previewPdfBtn : gerarPdfBtn;
            const originalTargetBtnHtml = targetButton.innerHTML;

            targetButton.disabled = true;
            targetButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Gerando...';

            try {
                const pdfBlob = await romaneio_gerarPdfInternal();
                if (!pdfBlob) {
                    targetButton.disabled = false;
                    targetButton.innerHTML = originalTargetBtnHtml;
                    return;
                }

                if (action === 'save') {
                    const fileName = `Romaneio_${document.getElementById('romaneioCliente').value.trim().replace(/\s+/g, '_') || 'Sem_Cliente'}_${new Date().toISOString().slice(0,10)}.pdf`;
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(pdfBlob);
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                    showToast('PDF do romaneio gerado com sucesso!', 'success');
                } else if (action === 'preview') {
                    romaneio_tempPdfBlob = pdfBlob;
                    pdfPreviewIframe.src = URL.createObjectURL(pdfBlob);
                    pdfPreviewModal.classList.add('active'); // Use 'active' class
                    pdfPreviewModal.classList.toggle('dark', htmlElement.classList.contains('dark'));
                }

            } catch (error) {
                console.error('Erro ao gerar PDF do romaneio:', error);
                showToast('Ocorreu um erro ao gerar o PDF do romaneio.', 'danger');
            } finally {
                targetButton.disabled = false;
                targetButton.innerHTML = originalTargetBtnHtml;
            }
        }

        async function romaneio_showPdfPreview() {
            if (romaneio_romaneioItens.length === 0) {
                showToast('Adicione itens ao romaneio para pré-visualizar.', 'warning');
                return;
            }
            await romaneio_gerarPdf('preview');
        }

        function romaneio_closePdfPreviewModalFunction() {
            const pdfPreviewModal = document.getElementById('romaneioPdfPreviewModal');
            const pdfPreviewIframe = document.getElementById('romaneioPdfPreviewIframe');

            pdfPreviewModal.classList.remove('active'); // Use 'active' class
            pdfPreviewIframe.src = 'about:blank';
            if (romaneio_tempPdfBlob) {
                URL.revokeObjectURL(pdfPreviewIframe.src);
                romaneio_tempPdfBlob = null;
            }
        }


        // --- Funções do Resumo de Pedidos (Prefixadas com 'resumoPedidos_') ---
        let resumoPedidos_pedidos = [];
        let resumoPedidos_editIndex = -1;
        let resumoPedidos_logoDataUrl = '';

        function resumoPedidos_initializeResumoPedidos() {
            // Elementos do formulário
            const nomeClienteInput = document.getElementById('resumoPedidosNomeCliente');
            const quantidadeInput = document.getElementById('resumoPedidosQuantidade');
            const unidadeSelect = document.getElementById('resumoPedidosUnidade');
            const descricaoInput = document.getElementById('resumoPedidosDescricao');
            const valorUnitarioInput = document.getElementById('resumoPedidosValorUnitario');
            const adiantamentoInput = document.getElementById('resumoPedidosAdiantamento');
            const descontoInput = document.getElementById('resumoPedidosDesconto');
            const comentariosInput = document.getElementById('resumoPedidosComentarios');
            const dadosEmpresaRodapeInput = document.getElementById('resumoPedidosDadosEmpresaRodape');
            const subtotalDisplay = document.getElementById('resumoPedidosSubtotalDisplay');
            const valorFinalDisplay = document.getElementById('resumoPedidosValorFinal');
            const salvarBtn = document.getElementById('resumoPedidosSalvar');
            const pedidosList = document.getElementById('resumoPedidosList');
            const addLogoBtn = document.getElementById('resumoPedidosAddLogo');
            const exportPdfBtn = document.getElementById('resumoPedidosExportPdf');
            const clearOrdersBtn = document.getElementById('resumoPedidosClearOrders');
            const logoFileInput = document.getElementById('resumoPedidosLogoFileInput');

            // Adiciona listeners para formatar os campos de valor
            [valorUnitarioInput, adiantamentoInput, descontoInput].forEach(input => {
                input.addEventListener('focus', (e) => {
                    // Ao focar, mostra o valor numérico puro para edição
                    e.target.value = resumoPedidos_parseCurrency(e.target.value).toFixed(2);
                });
                input.addEventListener('blur', (e) => {
                    // Ao desfocar, formata de volta para moeda
                    e.target.value = resumoPedidos_formatCurrency(resumoPedidos_parseCurrency(e.target.value));
                    resumoPedidos_calcularValores();
                });
                // Na inicialização, garante que o valor seja formatado corretamente
                input.value = resumoPedidos_formatCurrency(resumoPedidos_parseCurrency(input.value));
            });

            quantidadeInput.oninput = resumoPedidos_calcularValores;
            valorUnitarioInput.oninput = resumoPedidos_calcularValores;
            adiantamentoInput.oninput = resumoPedidos_calcularValores;
            descontoInput.oninput = resumoPedidos_calcularValores;

            salvarBtn.onclick = resumoPedidos_salvarPedido;
            addLogoBtn.onclick = resumoPedidos_handleAddLogoClick;
            logoFileInput.onchange = resumoPedidos_handleLogoFileInputChange;
            exportPdfBtn.onclick = resumoPedidos_handleExportPdfClick;
            clearOrdersBtn.onclick = resumoPedidos_handleClearOrdersClick;

            resumoPedidos_loadSavedData();
            resumoPedidos_atualizarListaPedidos();
            resumoPedidos_calcularValores();
        }

        function resumoPedidos_formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }

        function resumoPedidos_parseCurrency(text) {
            // Remove 'R$', dots for thousands, and replace comma with dot for decimals
            return parseFloat(text.replace('R$', '').replace(/\./g, '').replace(',', '.') || 0);
        }

        function resumoPedidos_calcularValores() {
            const quantidade = parseFloat(document.getElementById('resumoPedidosQuantidade').value) || 0;
            const valorUnitario = resumoPedidos_parseCurrency(document.getElementById('resumoPedidosValorUnitario').value);
            const adiantamento = resumoPedidos_parseCurrency(document.getElementById('resumoPedidosAdiantamento').value);
            const desconto = resumoPedidos_parseCurrency(document.getElementById('resumoPedidosDesconto').value);

            const subtotal = quantidade * valorUnitario;
            const valorFinal = subtotal - adiantamento - desconto;

            document.getElementById('resumoPedidosSubtotalDisplay').textContent = subtotal.toFixed(2).replace('.', ',');
            document.getElementById('resumoPedidosValorFinal').textContent = valorFinal.toFixed(2).replace('.', ',');
        }

        function resumoPedidos_formatDate(date) {
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const year = date.getFullYear();
            return `${day}/${month}/${year}`;
        }

        function resumoPedidos_readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function resumoPedidos_handleAddLogoClick() {
            const addLogoBtn = document.getElementById('resumoPedidosAddLogo');
            const logoFileInput = document.getElementById('resumoPedidosLogoFileInput');
            const watermarkContainer = document.getElementById('resumoPedidosWatermarkContainer');

            if (resumoPedidos_logoDataUrl) {
                resumoPedidos_logoDataUrl = '';
                watermarkContainer.innerHTML = '';
                addLogoBtn.innerHTML = '<i class="fas fa-image"></i> Inserir Logo';
                showToast('Logo removido com sucesso!', 'success');
                resumoPedidos_saveToLocalStorage();
            } else {
                logoFileInput.click();
            }
        }

        async function resumoPedidos_handleLogoFileInputChange(e) {
            const file = e.target.files[0];
            if (!file) return;

            const addLogoBtn = document.getElementById('resumoPedidosAddLogo');
            const watermarkContainer = document.getElementById('resumoPedidosWatermarkContainer');

            try {
                resumoPedidos_logoDataUrl = await resumoPedidos_readFileAsDataURL(file);

                watermarkContainer.innerHTML = '';
                const logo = document.createElement('img');
                logo.src = resumoPedidos_logoDataUrl;
                logo.alt = 'Logo da Empresa';
                logo.className = 'watermark';
                watermarkContainer.appendChild(logo);

                addLogoBtn.innerHTML = '<i class="fas fa-trash"></i> Remover Logo';
                showToast('Logo adicionado com sucesso!', 'success');
                resumoPedidos_saveToLocalStorage();
            } catch (error) {
                console.error('Erro ao carregar logo:', error);
                showToast('Erro ao carregar a imagem do logo.', 'danger');
            }
            document.getElementById('resumoPedidosLogoFileInput').value = '';
        }

        function resumoPedidos_saveToLocalStorage() {
            localStorage.setItem('resumoPedidos', JSON.stringify(resumoPedidos_pedidos));
            localStorage.setItem('resumoPedidosLogoDataUrl', resumoPedidos_logoDataUrl);
        }

        function resumoPedidos_loadSavedData() {
            const savedPedidos = localStorage.getItem('resumoPedidos');
            if (savedPedidos) {
                resumoPedidos_pedidos = JSON.parse(savedPedidos);
            }
            const savedLogo = localStorage.getItem('resumoPedidosLogoDataUrl');
            if (savedLogo) {
                resumoPedidos_logoDataUrl = savedLogo;
                const watermarkContainer = document.getElementById('resumoPedidosWatermarkContainer');
                watermarkContainer.innerHTML = '';
                const logo = document.createElement('img');
                logo.src = resumoPedidos_logoDataUrl;
                logo.alt = 'Logo da Empresa';
                logo.className = 'watermark';
                watermarkContainer.appendChild(logo);
                document.getElementById('resumoPedidosAddLogo').innerHTML = '<i class="fas fa-trash"></i> Remover Logo';
            }
        }

        function resumoPedidos_salvarPedido() {
            const nomeCliente = document.getElementById('resumoPedidosNomeCliente').value.trim();
            const quantidade = parseFloat(document.getElementById('resumoPedidosQuantidade').value);
            const unidade = document.getElementById('resumoPedidosUnidade').value;
            const descricao = document.getElementById('resumoPedidosDescricao').value.trim();
            const valorUnitario = resumoPedidos_parseCurrency(document.getElementById('resumoPedidosValorUnitario').value);
            const adiantamento = resumoPedidos_parseCurrency(document.getElementById('resumoPedidosAdiantamento').value);
            const desconto = resumoPedidos_parseCurrency(document.getElementById('resumoPedidosDesconto').value);
            const comentarios = document.getElementById('resumoPedidosComentarios').value.trim();
            const dadosEmpresaRodape = document.getElementById('resumoPedidosDadosEmpresaRodape').value.trim();
            const subtotal = parseFloat(document.getElementById('resumoPedidosSubtotalDisplay').textContent.replace(',', '.'));
            const valorTotalAPagar = parseFloat(document.getElementById('resumoPedidosValorFinal').textContent.replace(',', '.'));

            if (!quantidade || isNaN(quantidade) || quantidade < 0) {
                showToast('Por favor, informe uma quantidade válida e positiva.', 'danger');
                document.getElementById('resumoPedidosQuantidade').focus();
                return;
            }
            if (!descricao) {
                showToast('Por favor, informe a descrição do produto/serviço.', 'danger');
                document.getElementById('resumoPedidosDescricao').focus();
                return;
            }
            if (isNaN(valorUnitario) || valorUnitario < 0) {
                showToast('Por favor, informe um valor unitário válido e positivo.', 'danger');
                document.getElementById('resumoPedidosValorUnitario').focus();
                return;
            }

            const pedido = {
                nomeCliente,
                quantidade,
                unidade,
                descricao,
                valorUnitario,
                subtotal,
                adiantamento,
                desconto,
                valorTotalAPagar,
                comentarios,
                dadosEmpresaRodape
            };

            if (resumoPedidos_editIndex === -1) {
                resumoPedidos_pedidos.push(pedido);
                showToast('Pedido adicionado com sucesso!', 'success');
            } else {
                resumoPedidos_pedidos[resumoPedidos_editIndex] = pedido;
                resumoPedidos_editIndex = -1;
                document.getElementById('resumoPedidosSalvar').innerHTML = '<i class="fas fa-save"></i> Salvar Pedido';
                showToast('Pedido atualizado com sucesso!', 'success');
            }

            resumoPedidos_atualizarListaPedidos();
            resumoPedidos_limparFormulario();
            resumoPedidos_saveToLocalStorage();
        }

        function resumoPedidos_atualizarListaPedidos() {
            const pedidosList = document.getElementById('resumoPedidosList');
            pedidosList.innerHTML = '';

            if (resumoPedidos_pedidos.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td colspan="10" class="px-6 py-4 text-center text-gray-500 dark:text-gray-400">
                        Nenhum pedido registrado ainda. Adicione seu primeiro pedido acima.
                    </td>
                `;
                pedidosList.appendChild(tr);
                return;
            }

            resumoPedidos_pedidos.forEach((pedido, index) => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 dark:hover:bg-gray-700';

                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-gray-800 dark:text-gray-200">${pedido.nomeCliente || 'Não Informado'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-gray-800 dark:text-gray-200">${pedido.quantidade}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-gray-800 dark:text-gray-200">${pedido.unidade}</td>
                    <td class="px-6 py-4 text-gray-800 dark:text-gray-200">${pedido.descricao}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-gray-800 dark:text-gray-200">${resumoPedidos_formatCurrency(pedido.valorUnitario)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-gray-800 dark:text-gray-200">${resumoPedidos_formatCurrency(pedido.subtotal)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-gray-800 dark:text-gray-200">${resumoPedidos_formatCurrency(pedido.adiantamento)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-gray-800 dark:text-gray-200">${resumoPedidos_formatCurrency(pedido.desconto)}</td>
                    <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-800 dark:text-gray-200">${resumoPedidos_formatCurrency(pedido.valorTotalAPagar)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <button onclick="resumoPedidos_editarPedido(${index})" class="text-blue-600 hover:text-blue-900 mr-3 p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="resumoPedidos_showConfirmDeleteModal(${index})" class="text-red-600 hover:text-red-900 p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;

                pedidosList.appendChild(tr);
            });
        }

        function resumoPedidos_limparFormulario() {
            document.getElementById('resumoPedidosQuantidade').value = '';
            document.getElementById('resumoPedidosUnidade').value = 'ml';
            document.getElementById('resumoPedidosDescricao').value = '';
            document.getElementById('resumoPedidosValorUnitario').value = resumoPedidos_formatCurrency(0);
            document.getElementById('resumoPedidosAdiantamento').value = resumoPedidos_formatCurrency(0);
            document.getElementById('resumoPedidosDesconto').value = resumoPedidos_formatCurrency(0);
            document.getElementById('resumoPedidosComentarios').value = '';
            // document.getElementById('resumoPedidosDadosEmpresaRodape').value = 'Serraria Oliveira - Rodovia BR-230 - Transamazônica, s/n, Estrada São Joaquim, Bairro Liberdade, Altamira/PA';
            document.getElementById('resumoPedidosSubtotalDisplay').textContent = '0,00';
            document.getElementById('resumoPedidosValorFinal').textContent = '0,00';
            document.getElementById('resumoPedidosQuantidade').focus();
        }

        function resumoPedidos_limparFormularioCompleto() {
            document.getElementById('resumoPedidosNomeCliente').value = '';
            document.getElementById('resumoPedidosQuantidade').value = '';
            document.getElementById('resumoPedidosUnidade').value = 'ml';
            document.getElementById('resumoPedidosDescricao').value = '';
            document.getElementById('resumoPedidosValorUnitario').value = resumoPedidos_formatCurrency(0);
            document.getElementById('resumoPedidosAdiantamento').value = resumoPedidos_formatCurrency(0);
            document.getElementById('resumoPedidosDesconto').value = resumoPedidos_formatCurrency(0);
            document.getElementById('resumoPedidosComentarios').value = '';
            document.getElementById('resumoPedidosDadosEmpresaRodape').value = 'Serraria Oliveira - Rodovia BR-230 - Transamazônica, s/n, Estrada São Joaquim, Bairro Liberdade, Altamira/PA';
            document.getElementById('resumoPedidosSubtotalDisplay').textContent = '0,00';
            document.getElementById('resumoPedidosValorFinal').textContent = '0,00';
            document.getElementById('resumoPedidosNomeCliente').focus();
        }

        window.resumoPedidos_editarPedido = function(index) {
            const pedido = resumoPedidos_pedidos[index];

            document.getElementById('resumoPedidosNomeCliente').value = pedido.nomeCliente;
            document.getElementById('resumoPedidosQuantidade').value = pedido.quantidade;
            document.getElementById('resumoPedidosUnidade').value = pedido.unidade;
            document.getElementById('resumoPedidosDescricao').value = pedido.descricao;
            document.getElementById('resumoPedidosValorUnitario').value = pedido.valorUnitario.toFixed(2); // Exibe o número puro para edição
            document.getElementById('resumoPedidosAdiantamento').value = pedido.adiantamento.toFixed(2);
            document.getElementById('resumoPedidosDesconto').value = pedido.desconto.toFixed(2);
            document.getElementById('resumoPedidosComentarios').value = pedido.comentarios;
            document.getElementById('resumoPedidosDadosEmpresaRodape').value = pedido.dadosEmpresaRodape || 'Serraria Oliveira - Rodovia BR-230 - Transamazônica, s/n, Estrada São Joaquim, Bairro Liberdade, Altamira/PA';
            document.getElementById('resumoPedidosSubtotalDisplay').textContent = pedido.subtotal.toFixed(2).replace('.', ',');
            document.getElementById('resumoPedidosValorFinal').textContent = pedido.valorTotalAPagar.toFixed(2).replace('.', ',');

            resumoPedidos_editIndex = index;
            document.getElementById('resumoPedidosSalvar').innerHTML = '<i class="fas fa-save"></i> Atualizar Pedido';

            document.getElementById('resumo-pedidos-modal').querySelector('.flex-1.overflow-auto').scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.resumoPedidos_excluirPedido = function(index) {
            resumoPedidos_pedidos.splice(index, 1);
            resumoPedidos_atualizarListaPedidos();

            if (resumoPedidos_editIndex === index) {
                resumoPedidos_editIndex = -1;
                resumoPedidos_limparFormulario();
                document.getElementById('resumoPedidosSalvar').innerHTML = '<i class="fas fa-save"></i> Salvar Pedido';
            } else if (resumoPedidos_editIndex > index) {
                resumoPedidos_editIndex--;
            }
            showToast('Pedido excluído com sucesso!', 'danger');
            resumoPedidos_saveToLocalStorage();
        };

        function resumoPedidos_showConfirmDeleteModal(index) {
            showConfirmModal(
                'Confirmar Exclusão',
                'Tem certeza que deseja excluir este pedido?',
                () => resumoPedidos_excluirPedido(index),
                'Excluir',
                'Cancelar'
            );
        }

        function resumoPedidos_handleClearOrdersClick() {
            showConfirmModal(
                'Confirmar Limpeza Total',
                'Tem certeza que deseja limpar TODOS os pedidos da lista? Esta ação não pode ser desfeita.',
                () => {
                    resumoPedidos_pedidos = [];
                    resumoPedidos_atualizarListaPedidos();
                    resumoPedidos_limparFormularioCompleto();
                    showToast('Todos os pedidos foram limpos!', 'success');
                    resumoPedidos_saveToLocalStorage();
                },
                'Limpar Tudo',
                'Cancelar'
            );
        }

        async function resumoPedidos_handleExportPdfClick() {
            if (resumoPedidos_pedidos.length === 0) {
                showToast('Não há pedidos para exportar.', 'danger');
                return;
            }

            const pedidosPorCliente = {};
            resumoPedidos_pedidos.forEach(pedido => {
                const clientKey = pedido.nomeCliente || 'Pedidos Diversos';
                if (!pedidosPorCliente[clientKey]) {
                    pedidosPorCliente[clientKey] = { orders: [], comentarios: pedido.comentarios, dadosEmpresaRodape: pedido.dadosEmpresaRodape };
                }
                pedidosPorCliente[clientKey].orders.push(pedido);
                pedidosPorCliente[clientKey].comentarios = pedido.comentarios;
                pedidosPorCliente[clientKey].dadosEmpresaRodape = pedido.dadosEmpresaRodape;
            });

            const exportPdfBtn = document.getElementById('resumoPedidosExportPdf');
            const originalContent = exportPdfBtn.innerHTML;
            exportPdfBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando PDF...';
            exportPdfBtn.disabled = true;

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 15;

                let logoImg = null;
                if (resumoPedidos_logoDataUrl) {
                    logoImg = new Image();
                    logoImg.src = resumoPedidos_logoDataUrl;
                    await new Promise(resolve => {
                        logoImg.onload = resolve;
                        logoImg.onerror = () => {
                            console.warn("Não foi possível carregar a imagem do logo para o PDF.");
                            logoImg = null;
                            resolve();
                        };
                    });
                }

                const clientNames = Object.keys(pedidosPorCliente);

                for (let i = 0; i < clientNames.length; i++) {
                    const clientName = clientNames[i];
                    const clientData = pedidosPorCliente[clientName];
                    const clientOrders = clientData.orders;
                    const clientComments = clientData.comentarios;
                    const clientDadosEmpresaRodape = clientData.dadosEmpresaRodape;

                    if (i > 0) {
                        doc.addPage();
                    }
                    let yPos = margin;

                    doc.setFontSize(22);
                    doc.setFont('helvetica', 'bold');
                    doc.text('Resumo de Pedido', margin, yPos + 10);
                    yPos += 20;

                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'normal');
                    doc.text(`Cliente: ${clientName}`, margin, yPos);
                    yPos += 7;
                    doc.text(`Data: ${resumoPedidos_formatDate(new Date())}`, margin, yPos);
                    yPos += 15;

                    if (logoImg) {
                        const logoWidth = 20;
                        const logoHeight = (logoImg.height * logoWidth) / logoImg.width;
                        const logoX = pageWidth - margin - logoWidth;
                        const logoY = margin + 5;
                        doc.addImage(logoImg, 'PNG', logoX, logoY, logoWidth, logoHeight);
                    }

                    const headers = [
                        ['Qtd.', 'Un.', 'Descrição', 'Valor Unitário', 'Subtotal']
                    ];

                    const data = clientOrders.map(p => [
                        p.quantidade,
                        p.unidade,
                        p.descricao,
                        resumoPedidos_formatCurrency(p.valorUnitario),
                        resumoPedidos_formatCurrency(p.subtotal)
                    ]);

                    doc.autoTable({
                        startY: yPos,
                        head: headers,
                        body: data,
                        theme: 'grid',
                        styles: {
                            fontSize: 10,
                            cellPadding: 3,
                            valign: 'middle',
                            halign: 'left'
                        },
                        headStyles: {
                            fillColor: '#f3f4f6',
                            textColor: '#4b5563',
                            fontStyle: 'bold',
                            halign: 'center'
                        },
                        columnStyles: {
                            0: { halign: 'center', cellWidth: 25 },
                            1: { halign: 'center', cellWidth: 15 },
                            2: { halign: 'left', cellWidth: 'auto' },
                            3: { halign: 'right', cellWidth: 30 },
                            4: { halign: 'right', cellWidth: 35 }
                        },
                        didDrawPage: function(data) {
                            // Footer per page if needed
                        }
                    });

                    yPos = doc.autoTable.previous.finalY + 10;

                    let totalGeral = 0;
                    let totalAdiantamento = 0;
                    let totalDesconto = 0;
                    let totalAPagarGeral = 0;

                    clientOrders.forEach(p => {
                        totalGeral += p.subtotal;
                        totalAdiantamento += p.adiantamento;
                        totalDesconto += p.desconto;
                        totalAPagarGeral += p.valorTotalAPagar;
                    });

                    doc.setFontSize(12);
                    doc.setFont('helvetica', 'normal');

                    doc.text('RESUMO FINANCEIRO:', margin, yPos);
                    yPos += 7;
                    doc.text(`Total dos Itens: ${resumoPedidos_formatCurrency(totalGeral)}`, margin, yPos);
                    yPos += 7;
                    doc.text(`Adiantamento: - ${resumoPedidos_formatCurrency(totalAdiantamento)}`, margin, yPos);
                    yPos += 7;
                    doc.text(`Desconto: - ${resumoPedidos_formatCurrency(totalDesconto)}`, margin, yPos);
                    yPos += 10;
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(14);
                    doc.text(`TOTAL A PAGAR: ${resumoPedidos_formatCurrency(totalAPagarGeral)}`, margin, yPos);
                    yPos += 15;

                    if (clientComments) {
                        doc.setFontSize(10);
                        doc.setFont('helvetica', 'normal');
                        doc.text('Comentários / Dados Bancários:', margin, yPos);
                        yPos += 5;
                        const splitComments = doc.splitTextToSize(clientComments, pageWidth - (2 * margin));
                        doc.text(splitComments, margin, yPos);
                        yPos += (splitComments.length * 4) + 10;
                    }

                    const footerBaseY = pageHeight - margin;
                    const developerNameY = footerBaseY - 5;
                    let signatureLineY = yPos + 20;

                    const requiredSpaceForFooter = 60;
                    if (yPos > pageHeight - requiredSpaceForFooter) {
                        doc.addPage();
                        yPos = margin;
                        signatureLineY = yPos + 20;
                    }

                    doc.setFontSize(9);
                    doc.setFont('helvetica', 'normal');

                    doc.line(margin + 20, signatureLineY, margin + 80, signatureLineY);
                    doc.text('Assinatura do Cliente', margin + 25, signatureLineY + 5);

                    if (clientDadosEmpresaRodape) {
                        const splitDadosEmpresa = doc.splitTextToSize(clientDadosEmpresaRodape, pageWidth - (2 * margin));
                        const centerX = pageWidth / 2;

                        let companyFooterY = developerNameY - 5;
                        for (let line of splitDadosEmpresa) {
                            doc.text(line, centerX, companyFooterY, { align: 'center' });
                            companyFooterY += 4;
                        }
                    }
                }

                doc.save(`resumo_pedidos_${resumoPedidos_formatDate(new Date()).replace(/\//g, '-')}.pdf`);
                showToast('PDF do resumo de pedidos exportado com sucesso!', 'success');

            } catch (error) {
                console.error('Erro ao gerar PDF do resumo de pedidos:', error);
                showToast('Ocorreu um erro ao gerar o PDF do resumo de pedidos. Por favor, tente novamente.', 'danger');
            } finally {
                exportPdfBtn.innerHTML = originalContent;
                exportPdfBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
